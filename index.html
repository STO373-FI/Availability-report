<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STO373 Availability report</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f3f4f6; display: flex; color: #333; }
        .sidebar { width: 260px; background-color: #003399; color: white; padding: 20px; height: 100vh; position: fixed; box-sizing: border-box; }
        .sidebar h2 { font-size: 20px; margin-bottom: 30px; border-bottom: 2px solid #ffcc00; padding-bottom: 10px; }
        .sidebar label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; color: #ffd100; }
        .sidebar select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: none; background-color: white; color: #333; font-weight: bold; }
        
        .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); box-sizing: border-box; }
        .header-title { font-size: 28px; font-weight: bold; margin-bottom: 20px; color: #003399; }
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* í”¼ë²—ëœ í…Œì´ë¸”ì€ ê°€ë¡œë¡œ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìŠ¤í¬ë¡¤ ì²˜ë¦¬ */
        .table-container { overflow-x: auto; white-space: nowrap; }
        table { border-collapse: collapse; margin-top: 10px; font-size: 13px; text-align: center; }
        th, td { padding: 10px 15px; border: 1px solid #ddd; }
        th { background-color: #f8f9fa; color: #333; font-weight: bold; }
        /* ì²« ë²ˆì§¸ ì—´(ì´ë¦„/ì§€í‘œ) ê°•ì¡° ë° ê³ ì • íš¨ê³¼ ë¶€ì—¬ ê°€ëŠ¥ */
        td:first-child, th:first-child { font-weight: bold; background-color: #eef2f5; text-align: left; }
        
        #loading { color: #d9534f; font-weight: bold; font-size: 16px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>ğŸ“Š STO373<br>Availability Report</h2>
        
        <label>View Level</label>
        <select id="viewLevel" onchange="updateView()">
            <option value="store">1. Store Overview</option>
            <option value="hfb">2. HFB Level</option>
            <option value="article">3. Article Level</option>
        </select>

        <label>Store</label>
        <select id="storeSelect" onchange="updateView()">
            <option value="Loading...">Loading...</option>
        </select>
        
        <div id="hfbFilter" style="display: none;">
            <label>HFB</label>
            <select id="hfbSelect" onchange="updateView()"></select>
        </div>

        <div id="articleFilter" style="display: none;">
            <label>Article (Item No.)</label>
            <select id="articleSelect" onchange="updateView()"></select>
        </div>
    </div>

    <div class="main-content">
        <div class="header-title" id="mainTitle">Store Overview</div>
        <div id="loading">ë°ì´í„°(FY26 OSA.xlsx)ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>
        
        <div id="dashboard" style="display: none;">
            <div class="card">
                <div id="chartDiv" style="width:100%; height:400px;"></div>
            </div>
            
            <div class="card">
                <h3 style="margin-top:0; color:#333; font-size:18px;">Data Details</h3>
                <div class="table-container">
                    <table id="dataTable">
                        <thead><tr id="tableHead"></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let excelData = {}; 

        async function loadExcelFile() {
            try {
                const response = await fetch('./FY26 OSA.xlsx');
                if (!response.ok) throw new Error("File not found");
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                const getSheetData = (sheetName) => {
                    const sheet = workbook.Sheets[sheetName];
                    if(!sheet) return [];
                    return XLSX.utils.sheet_to_json(sheet, { defval: "" }).map(row => {
                        let newRow = {};
                        for (let key in row) newRow[key.trim()] = row[key];
                        return newRow;
                    });
                };

                excelData.STO_OSA = getSheetData('STO_OSA');
                excelData.HFB = getSheetData('HFB');
                excelData.Article_level = getSheetData('Article_level');

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

                initFilters();
            } catch (error) {
                document.getElementById('loading').innerText = "ì˜¤ë¥˜: 'FY26 OSA.xlsx' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                console.error(error);
            }
        }

        function initFilters() {
            const stores = [...new Set(excelData.STO_OSA.map(d => d['BU - Business Unit']))].sort();
            const storeSelect = document.getElementById('storeSelect');
            storeSelect.innerHTML = stores.map(s => `<option value="${s}" ${s.includes('373') ? 'selected' : ''}>${s}</option>`).join('');
            updateView();
        }

        function updateView() {
            const level = document.getElementById('viewLevel').value;
            const store = document.getElementById('storeSelect').value;
            
            document.getElementById('hfbFilter').style.display = (level === 'hfb' || level === 'article') ? 'block' : 'none';
            document.getElementById('articleFilter').style.display = (level === 'article') ? 'block' : 'none';

            if (level === 'store') {
                document.getElementById('mainTitle').innerText = `1. Store Overview (${store})`;
                renderStoreData(store);
            } else if (level === 'hfb') {
                document.getElementById('mainTitle').innerText = `2. HFB Level (${store})`;
                updateHFBDropdown(store);
                renderHFBData(store);
            } else if (level === 'article') {
                document.getElementById('mainTitle').innerText = `3. Article Level (${store})`;
                updateHFBDropdown(store); 
                updateArticleDropdown(store);
                renderArticleData(store);
            }
        }

        function updateHFBDropdown(store) {
            const hfbSelect = document.getElementById('hfbSelect');
            const currentVal = hfbSelect.value;
            const hfbs = [...new Set(excelData.HFB.filter(d => d['BU - Business Unit'] === store).map(d => d['HFB Name - Home Furnishing Business Name']))].sort();
            hfbSelect.innerHTML = hfbs.map(h => `<option value="${h}">${h}</option>`).join('');
            if (hfbs.includes(currentVal)) hfbSelect.value = currentVal;
        }

        function updateArticleDropdown(store) {
            const hfb = document.getElementById('hfbSelect').value;
            const articleSelect = document.getElementById('articleSelect');
            const rawArticles = excelData.Article_level.filter(d => d['BU - Business Unit'] === store);
            const articles = [...new Set(rawArticles.map(d => d['Item Number'] + " - " + d['artname']))].sort();
            articleSelect.innerHTML = articles.map(a => `<option value="${a.split(' - ')[0]}">${a}</option>`).join('');
        }

        // --- ë Œë”ë§ ë¡œì§ (Xì¶• ë¬¸ìë¡œ ê°•ì œ, ë¹ˆ ë°ì´í„° ì œê±°, í…Œì´ë¸” í”¼ë²—) ---

        function renderStoreData(store) {
            // ë¹ˆ ë°ì´í„°(ë¯¸ë˜ ì˜ˆì¸¡ë¶„ ë“±) ì œê±° í•„í„°ë§ ì¶”ê°€
            let data = excelData.STO_OSA.filter(d => 
                d['BU - Business Unit'] === store && d['OSA'] !== "" && !isNaN(parseFloat(d['OSA']))
            ).sort((a,b) => a['YW - Year Week'] - b['YW - Year Week']);
            
            const weeks = data.map(d => String(d['YW - Year Week'])); // Xì¶• ê°•ì œ ë¬¸ìí™”
            const osas = data.map(d => parseFloat(d['OSA']));

            Plotly.newPlot('chartDiv', [{
                x: weeks, y: osas,
                type: 'scatter', mode: 'lines+markers', name: 'OSA', line: {color: '#0058a3', width: 3}
            }], { 
                title: 'Weekly OSA Trend', 
                xaxis: { type: 'category' }, // Category ì†ì„± ì¶”ê°€í•˜ì—¬ 2025.3k ë°©ì§€
                yaxis: { tickformat: '.1%', range: [0.8, 1.05] }, margin: { t: 40, b: 40 }
            });

            // í…Œì´ë¸” í”¼ë²—: ì—´ ì´ë¦„ì€ Store + ì£¼ì°¨ë“¤
            const headers = ['Store'].concat(weeks);
            const rowData = [store].concat(osas.map(v => (v * 100).toFixed(1) + '%'));
            drawTable(headers, [rowData]);
        }

        function renderHFBData(store) {
            const hfb = document.getElementById('hfbSelect').value;
            if(!hfb) return;
            
            let data = excelData.HFB.filter(d => 
                d['BU - Business Unit'] === store && d['HFB Name - Home Furnishing Business Name'] === hfb && 
                d['OSA'] !== "" && !isNaN(parseFloat(d['OSA']))
            ).sort((a,b) => a['YW - Year Week'] - b['YW - Year Week']);
            
            const weeks = data.map(d => String(d['YW - Year Week']));
            const osas = data.map(d => parseFloat(d['OSA']));

            Plotly.newPlot('chartDiv', [{
                x: weeks, y: osas,
                type: 'scatter', mode: 'lines+markers', line: {color: '#e00751', width: 3}
            }], { 
                title: `${hfb} - OSA Trend`, 
                xaxis: { type: 'category' }, 
                yaxis: { tickformat: '.1%', range: [0.7, 1.05] } 
            });

            const headers = ['HFB Name'].concat(weeks);
            const rowData = [hfb].concat(osas.map(v => (v * 100).toFixed(1) + '%'));
            drawTable(headers, [rowData]);
        }

        function renderArticleData(store) {
            const itemNo = document.getElementById('articleSelect').value;
            if(!itemNo) return;
            
            let data = excelData.Article_level.filter(d => 
                d['BU - Business Unit'] === store && String(d['Item Number']) === itemNo &&
                d['OSA'] !== "" && !isNaN(parseFloat(d['OSA']))
            ).sort((a,b) => a['YW - Year Week'] - b['YW - Year Week']);
            
            const weeks = data.map(d => String(d['YW - Year Week']));
            const osas = data.map(d => parseFloat(d['OSA']));
            const isas = data.map(d => parseFloat(d['ISA']));

            Plotly.newPlot('chartDiv', [
                { x: weeks, y: osas, type: 'scatter', mode: 'lines+markers', name: 'OSA', line: {color: '#0058a3'} },
                { x: weeks, y: isas, type: 'scatter', mode: 'lines+markers', name: 'ISA', line: {color: '#ff9900'} }
            ], { 
                title: `Item ${itemNo} - OSA vs ISA`, 
                xaxis: { type: 'category' }, 
                yaxis: { tickformat: '.0%', range: [0, 1.05] } 
            });

            const headers = ['Metric'].concat(weeks);
            // Article ë ˆë²¨ì€ OSA, ISA ë‘ ì¤„ë¡œ í‘œì‹œ
            const osaRow = ['OSA %'].concat(osas.map(v => (v * 100).toFixed(1) + '%'));
            const isaRow = ['ISA %'].concat(isas.map(v => (v * 100).toFixed(1) + '%'));
            
            drawTable(headers, [osaRow, isaRow]);
        }

        function drawTable(headers, rows) {
            document.getElementById('tableHead').innerHTML = headers.map(h => `<th>${h}</th>`).join('');
            document.getElementById('tableBody').innerHTML = rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('');
        }

        window.onload = loadExcelFile;
    </script>
</body>
</html>
