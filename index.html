<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STO373 Availability report</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f3f4f6; display: flex; color: #333; }
        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ (Goods arrival í¼ ì°¸ê³ ) */
        .sidebar { width: 260px; background-color: #003399; color: white; padding: 20px; height: 100vh; position: fixed; box-sizing: border-box; }
        .sidebar h2 { font-size: 20px; margin-bottom: 30px; border-bottom: 2px solid #ffcc00; padding-bottom: 10px; }
        .sidebar label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; color: #ffd100; }
        .sidebar select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: none; background-color: white; color: #333; font-weight: bold; }
        
        /* ë©”ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); box-sizing: border-box; }
        .header-title { font-size: 28px; font-weight: bold; margin-bottom: 20px; color: #003399; }
        
        /* ì¹´ë“œ(ì»¨í…Œì´ë„ˆ) ìŠ¤íƒ€ì¼ */
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; text-align: center; }
        th, td { padding: 12px; border: 1px solid #ddd; }
        th { background-color: #f8f9fa; color: #333; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        
        #loading { color: #d9534f; font-weight: bold; font-size: 16px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>ğŸ“Š STO373<br>Availability Report</h2>
        
        <label>View Level</label>
        <select id="viewLevel" onchange="updateView()">
            <option value="store">1. Store Overview</option>
            <option value="hfb">2. HFB Level</option>
            <option value="article">3. Article Level</option>
        </select>

        <label>Store</label>
        <select id="storeSelect" onchange="updateView()">
            <option value="Loading...">Loading...</option>
        </select>
        
        <div id="hfbFilter" style="display: none;">
            <label>HFB</label>
            <select id="hfbSelect" onchange="updateView()"></select>
        </div>

        <div id="articleFilter" style="display: none;">
            <label>Article (Item No.)</label>
            <select id="articleSelect" onchange="updateView()"></select>
        </div>
    </div>

    <div class="main-content">
        <div class="header-title" id="mainTitle">Store Overview</div>
        <div id="loading">ë°ì´í„°(FY26 OSA.xlsx)ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>
        
        <div id="dashboard" style="display: none;">
            <div class="card">
                <div id="chartDiv" style="width:100%; height:400px;"></div>
            </div>
            
            <div class="card">
                <h3 style="margin-top:0; color:#333; font-size:18px;">Data Details</h3>
                <div style="overflow-x:auto;">
                    <table id="dataTable">
                        <thead><tr id="tableHead"></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let excelData = {}; 

        // 1. ì—‘ì…€ íŒŒì¼ ë¡œë“œ (SheetJS)
        async function loadExcelFile() {
            try {
                const response = await fetch('./FY26 OSA.xlsx');
                if (!response.ok) throw new Error("File not found");
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                const getSheetData = (sheetName) => {
                    const sheet = workbook.Sheets[sheetName];
                    if(!sheet) return [];
                    return XLSX.utils.sheet_to_json(sheet, { defval: "" }).map(row => {
                        let newRow = {};
                        for (let key in row) newRow[key.trim()] = row[key];
                        return newRow;
                    });
                };

                // í•„ìš”í•œ ì‹œíŠ¸ ì¶”ì¶œ
                excelData.STO_OSA = getSheetData('STO_OSA');
                excelData.HFB = getSheetData('HFB');
                excelData.Article_level = getSheetData('Article_level');

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

                initFilters();
            } catch (error) {
                document.getElementById('loading').innerText = "ì˜¤ë¥˜: 'FY26 OSA.xlsx' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                console.error(error);
            }
        }

        // 2. í•„í„° ì´ˆê¸°í™”
        function initFilters() {
            // Store í•„í„° ì„¸íŒ… (STO373ì„ ê¸°ë³¸ìœ¼ë¡œ ì„ íƒí•˜ë„ë¡ ìœ ë„)
            const stores = [...new Set(excelData.STO_OSA.map(d => d['BU - Business Unit']))].sort();
            const storeSelect = document.getElementById('storeSelect');
            storeSelect.innerHTML = stores.map(s => `<option value="${s}" ${s.includes('373') ? 'selected' : ''}>${s}</option>`).join('');
            
            updateView();
        }

        // 3. ë·° ì—…ë°ì´íŠ¸ ë¡œì§ (ì„ íƒ ë ˆë²¨ì— ë”°ë¼ UI ë° ë°ì´í„° ë³€ê²½)
        function updateView() {
            const level = document.getElementById('viewLevel').value;
            const store = document.getElementById('storeSelect').value;
            
            document.getElementById('hfbFilter').style.display = (level === 'hfb' || level === 'article') ? 'block' : 'none';
            document.getElementById('articleFilter').style.display = (level === 'article') ? 'block' : 'none';

            if (level === 'store') {
                document.getElementById('mainTitle').innerText = `1. Store Overview (${store})`;
                renderStoreData(store);
            } 
            else if (level === 'hfb') {
                document.getElementById('mainTitle').innerText = `2. HFB Level (${store})`;
                updateHFBDropdown(store);
                renderHFBData(store);
            } 
            else if (level === 'article') {
                document.getElementById('mainTitle').innerText = `3. Article Level (${store})`;
                updateHFBDropdown(store); 
                updateArticleDropdown(store);
                renderArticleData(store);
            }
        }

        // --- ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        function updateHFBDropdown(store) {
            const hfbSelect = document.getElementById('hfbSelect');
            const currentVal = hfbSelect.value;
            const hfbs = [...new Set(excelData.HFB.filter(d => d['BU - Business Unit'] === store).map(d => d['HFB Name - Home Furnishing Business Name']))].sort();
            hfbSelect.innerHTML = hfbs.map(h => `<option value="${h}">${h}</option>`).join('');
            if (hfbs.includes(currentVal)) hfbSelect.value = currentVal;
        }

        function updateArticleDropdown(store) {
            const hfb = document.getElementById('hfbSelect').value;
            const articleSelect = document.getElementById('articleSelect');
            // HFB ì´ë¦„ì—ì„œ ë²ˆí˜¸ ì¶”ì¶œ ë¡œì§ì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜, ì¼ë‹¨ ì „ì²´ ì œí’ˆëª… í‘œì‹œ
            const rawArticles = excelData.Article_level.filter(d => d['BU - Business Unit'] === store);
            const articles = [...new Set(rawArticles.map(d => d['Item Number'] + " - " + d['artname']))].sort();
            articleSelect.innerHTML = articles.map(a => `<option value="${a.split(' - ')[0]}">${a}</option>`).join('');
        }

        // --- ë Œë”ë§: 1. Store ---
        function renderStoreData(store) {
            let data = excelData.STO_OSA.filter(d => d['BU - Business Unit'] === store).sort((a,b) => a['YW - Year Week'] - b['YW - Year Week']);
            
            // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            Plotly.newPlot('chartDiv', [{
                x: data.map(d => d['YW - Year Week']), y: data.map(d => parseFloat(d['OSA'])),
                type: 'scatter', mode: 'lines+markers', name: 'OSA', line: {color: '#0058a3', width: 3}
            }], { 
                title: 'Weekly OSA Trend', yaxis: { tickformat: '.1%', range: [0.8, 1.05] }, margin: { t: 40, b: 40 }
            });

            // í…Œì´ë¸” ê·¸ë¦¬ê¸°
            drawTable(
                ['Year-Week', 'Store', 'OSA %'], 
                data.map(d => [d['YW - Year Week'], d['BU - Business Unit'], (parseFloat(d['OSA']) * 100).toFixed(2) + '%'])
            );
        }

        // --- ë Œë”ë§: 2. HFB ---
        function renderHFBData(store) {
            const hfb = document.getElementById('hfbSelect').value;
            if(!hfb) return;
            let data = excelData.HFB.filter(d => d['BU - Business Unit'] === store && d['HFB Name - Home Furnishing Business Name'] === hfb).sort((a,b) => a['YW - Year Week'] - b['YW - Year Week']);
            
            Plotly.newPlot('chartDiv', [{
                x: data.map(d => d['YW - Year Week']), y: data.map(d => parseFloat(d['OSA'])),
                type: 'scatter', mode: 'lines+markers', line: {color: '#e00751', width: 3}
            }], { title: `${hfb} - OSA Trend`, yaxis: { tickformat: '.1%', range: [0.7, 1.05] } });

            drawTable(
                ['Year-Week', 'HFB Name', 'OSA %'], 
                data.map(d => [d['YW - Year Week'], d['HFB Name - Home Furnishing Business Name'], (parseFloat(d['OSA']) * 100).toFixed(2) + '%'])
            );
        }

        // --- ë Œë”ë§: 3. Article ---
        function renderArticleData(store) {
            const itemNo = document.getElementById('articleSelect').value;
            if(!itemNo) return;
            let data = excelData.Article_level.filter(d => d['BU - Business Unit'] === store && String(d['Item Number']) === itemNo).sort((a,b) => a['YW - Year Week'] - b['YW - Year Week']);
            
            Plotly.newPlot('chartDiv', [
                { x: data.map(d => d['YW - Year Week']), y: data.map(d => parseFloat(d['OSA'])), type: 'scatter', mode: 'lines+markers', name: 'OSA' },
                { x: data.map(d => d['YW - Year Week']), y: data.map(d => parseFloat(d['ISA'])), type: 'scatter', mode: 'lines+markers', name: 'ISA' }
            ], { title: `Item ${itemNo} - OSA vs ISA`, yaxis: { tickformat: '.0%', range: [0, 1.05] } });

            drawTable(
                ['Year-Week', 'Item Number', 'Article Name', 'OSA %', 'ISA %'], 
                data.map(d => [d['YW - Year Week'], d['Item Number'], d['artname'], (parseFloat(d['OSA']) * 100).toFixed(1) + '%', (parseFloat(d['ISA']) * 100).toFixed(1) + '%'])
            );
        }

        // --- ê³µí†µ í…Œì´ë¸” ê·¸ë¦¬ê¸° í•¨ìˆ˜ ---
        function drawTable(headers, rows) {
            document.getElementById('tableHead').innerHTML = headers.map(h => `<th>${h}</th>`).join('');
            document.getElementById('tableBody').innerHTML = rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('');
        }

        window.onload = loadExcelFile;
    </script>
</body>
</html>
