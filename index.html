<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STO373 Availability report</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f3f4f6; display: flex; color: #333; }
        .sidebar { width: 260px; background-color: #003399; color: white; padding: 20px; height: 100vh; position: fixed; box-sizing: border-box; overflow-y: auto; z-index: 10; display: flex; flex-direction: column; }
        .sidebar-content { flex-grow: 1; }
        .sidebar h2 { font-size: 20px; margin-bottom: 30px; border-bottom: 2px solid #ffcc00; padding-bottom: 10px; cursor: pointer; transition: opacity 0.2s; }
        .sidebar h2:hover { opacity: 0.8; }
        .sidebar label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; color: #ffd100; }
        .sidebar select, .sidebar input, .sidebar button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: none; background-color: white; color: #333; font-weight: bold; box-sizing: border-box; }
        .sidebar button.primary { background-color: #ffcc00; color: #003399; cursor: pointer; margin-top: 10px; }
        .sidebar button.primary:hover { background-color: #ffd633; }
        .sidebar button.danger { background-color: #e74c3c; color: white; cursor: pointer; margin-top: 30px; border: 1px solid #c0392b; }
        .sidebar button.danger:hover { background-color: #c0392b; }
        .version-info { margin-top: 40px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 13px; text-align: center; }
        .version-text { color: white; font-weight: bold; font-size: 15px; }
        .update-text { color: #ffd100; margin-top: 4px; font-weight: bold; }
        
        .time-filter-container { display: flex; gap: 5px; align-items: center; margin-top: 5px; }
        .time-filter-container select { margin-top: 0; }
        
        #hierarchyFilters { margin-top: 15px; border-top: 1px dashed #668cff; padding-top: 5px; }
        
        .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); box-sizing: border-box; }
        .header-title { font-size: 28px; font-weight: bold; margin-bottom: 5px; color: #003399; }
        .header-desc { font-size: 14px; color: #666; margin-bottom: 20px; }
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .capa-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 15px; text-align: center; }
        .capa-table th { background-color: #003399; color: white; padding: 12px; }
        .capa-table td { background-color: #f8f9fa; padding: 10px; border: 1px solid #ddd; }
        .capa-input { width: 60px; padding: 8px; text-align: center; font-size: 16px; font-weight: bold; border: 2px solid #ccc; border-radius: 4px; }
        .capa-input:focus { border-color: #0058a3; outline: none; }
        .row-total { font-weight: bold; color: #d9534f; font-size: 18px; }

        .table-container { overflow-x: auto; white-space: nowrap; max-height: 500px; }
        table.data-table { border-collapse: collapse; margin-top: 10px; font-size: 13px; text-align: center; width: 100%; }
        table.data-table th, table.data-table td { padding: 10px 15px; border: 1px solid #ddd; }
        table.data-table th { background-color: #f8f9fa; color: #333; font-weight: bold; position: sticky; top: 0; z-index: 2; }
        table.data-table td:first-child, table.data-table th:first-child { font-weight: bold; background-color: #eef2f5; text-align: left; position: sticky; left: 0; z-index: 3; }
        table.data-table th:first-child { z-index: 4; }
        table.data-table th.proj-col { background-color: #ffe8a1; color: #003399; }
        table.data-table td.proj-cell { background-color: #fff8dc; font-style: italic; }
        
        #loading { font-size: 18px; font-weight: bold; color: #003399; display: flex; align-items: center; margin-bottom: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #ffcc00; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-right: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-content">
            <h2 onclick="window.location.reload();" title="í™ˆí˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°">ğŸ“Š Availability Report</h2>
            
            <label>1. View Level</label>
            <select id="viewLevel" onchange="updateSidebarUI()">
                <option value="settings" selected>0. CAPA Settings (Default)</option>
                <option value="store">1. Store Overview</option>
                <option value="hfb">2. HFB Level</option>
                <option value="pa">3. PA Level</option>
                <option value="article">4. Article Level</option>
            </select>
            
            <label>â±ï¸ Time Period</label>
            <div class="time-filter-container">
                <select id="fromWeek" onchange="updateView()"><option>Loading...</option></select>
                <span style="color:white;font-weight:bold;">~</span>
                <select id="toWeek" onchange="updateView()"><option>Loading...</option></select>
            </div>

            <div id="storeFilter" style="display:none;">
                <label>2. Select Store</label>
                <select id="storeSelect" onchange="updateSidebarUI()"><option value="Loading...">Loading...</option></select>
            </div>
            
            <div id="hierarchyFilters" style="display:none;">
                <label>3. Select HFB</label>
                <select id="hfbSelect" onchange="onHfbChange()"></select>
                
                <div id="paFilterContainer">
                    <label>4. Select PA</label>
                    <select id="paSelect" onchange="updateView()"></select>
                </div>
            </div>

            <div id="articleSearchFilter" style="display:none; margin-top: 15px;">
                <label>ğŸ” Specific Article (Optional)</label>
                <input type="text" id="articleInput" placeholder="ë¹ˆì¹¸ì´ë©´ ê·¸ë£¹ ì „ì²´ ì¡°íšŒ" onkeypress="handleEnter(event)">
                <button class="primary" onclick="updateView()">ì¡°íšŒí•˜ê¸°</button>
            </div>

            <button class="danger" onclick="forceRefreshCache()">ğŸ”„ ìºì‹œ í­íŒŒ & ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div class="version-info">
            <div class="version-text">ver 2.1.1</div>
            <div class="update-text">Last Updated: 2026.02.25</div>
        </div>
    </div>

    <div class="main-content">
        <div class="header-title" id="mainTitle">Logistics Simulation Settings</div>
        <div class="header-desc" id="subTitle">í–¥í›„ ì…ê³ ë  ì»¨í…Œì´ë„ˆì˜ ìš”ì¼ë³„ í•œë„(CAPA)ë¥¼ ì§ì ‘ ì¡°ì •í•˜ì—¬ ë¯¸ë˜ì˜ OSAë¥¼ ì˜ˆì¸¡í•´ë³´ì„¸ìš”.</div>
        
        <div id="loading">
            <div class="spinner"></div>
            <span id="loadingText">ì‹œìŠ¤í…œì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</span>
        </div>
        
        <div id="settingsView" style="display:none;">
            <div class="card">
                <h3 style="margin-top:0; color:#0058a3;">âš™ï¸ ì¼ì¼ í•˜ì—­ ìŠ¬ë¡¯(CAPA) ì„¤ì •</h3>
                <p style="color:#666; font-size:14px; margin-bottom: 20px;">
                    í•´ë‹¹ ìš”ì¼ì— ë§¤ì¥ì—ì„œ ì†Œí™” ê°€ëŠ¥í•œ ì»¨í…Œì´ë„ˆ ëŒ€ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
                    <b>[Trade-off ë£° ì ìš©]</b> ë¹ˆ ìŠ¬ë¡¯ì´ ìƒê¸°ë©´ <b>LF â¡ï¸ HF â¡ï¸ DD</b> ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ëŒ€ê¸°ì—´(Queue) ë¬¼ëŸ‰ì„ ë‹¹ê²¨ì™€ í•˜ë£¨ ì´ëŸ‰ì„ ê°€ë“ ì±„ì›ë‹ˆë‹¤.
                </p>
                <table class="capa-table">
                    <thead>
                        <tr>
                            <th>ìš”ì¼ (Day)</th>
                            <th>LF ìŠ¬ë¡¯ (ëŒ€)</th>
                            <th>HF ìŠ¬ë¡¯ (ëŒ€)</th>
                            <th>DD ìŠ¬ë¡¯ (ëŒ€)</th>
                            <th>ì¼ì¼ ì´í•©ê³„</th>
                        </tr>
                    </thead>
                    <tbody id="capaSettingsBody">
                    </tbody>
                </table>
                <div style="text-align:right; margin-top:20px;">
                    <button class="primary" style="font-size:16px; padding:12px 24px; border-radius: 8px;" onclick="applySimulationSettings()">ğŸš€ ì´ ì„¤ì •ìœ¼ë¡œ OSA ì˜ˆì¸¡ ë‹¤ì‹œ ëŒë¦¬ê¸°</button>
                </div>
            </div>
        </div>

        <div id="dashboard" style="display:none;">
            <div class="card">
                <div id="chartDiv" style="width:100%;height:600px;"></div>
            </div>
            
            <div class="card">
                <h3 style="margin-top:0;color:#333;font-size:18px;">Data Table</h3>
                <div class="table-container">
                    <table class="data-table" id="dataTable">
                        <thead><tr id="tableHead"></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let excelData = { STO_OSA: [], HFB: [], PA: [], Article_level: [], AL010: [], Table7: [], SHP: [] };
        let projectionData = { store: {}, hfb: {}, pa: {}, article: {}, weeks: [] };
        let lastActualWeek = "";
        let csmToSimulatedWeek = {};
        
        let hierarchy = {};
        let hfbNameMap = {}; 

        let capaConfig = {
            0: { LF: 1, HF: 1, DD: 3 }, // Sun
            1: { LF: 1, HF: 1, DD: 3 }, // Mon
            2: { LF: 1, HF: 1, DD: 3 }, // Tue
            3: { LF: 1, HF: 1, DD: 3 }, // Wed
            4: { LF: 1, HF: 1, DD: 3 }, // Thu
            5: { LF: 1, HF: 1, DD: 3 }, // Fri
            6: { LF: 1, HF: 1, DD: 3 }  // Sat
        };

        const dayNames = ["ì¼ìš”ì¼ (Sun)", "ì›”ìš”ì¼ (Mon)", "í™”ìš”ì¼ (Tue)", "ìˆ˜ìš”ì¼ (Wed)", "ëª©ìš”ì¼ (Thu)", "ê¸ˆìš”ì¼ (Fri)", "í† ìš”ì¼ (Sat)"];

        // ğŸŒŸ 1. ë°ë“œë½ ë°©ì§€ë¥¼ ìœ„í•´ DB ì´ë¦„ì„ v3ë¡œ ì™„ì „íˆ êµì²´
        const DB_NAME = "OsaDashboardDB_v3"; 
        const STORE_NAME = "cache";

        function openDB() {
            return new Promise((resolve, reject) => {
                let req = indexedDB.open(DB_NAME, 1); 
                req.onupgradeneeded = e => {
                    let db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                req.onsuccess = e => resolve(e.target.result);
                // ğŸŒŸ 2. íƒ­ ì¤‘ë³µ ì—ëŸ¬ë‚˜ ë¸”ë¡ ì—ëŸ¬ ì‹œ ì¦‰ì‹œ Reject ì²˜ë¦¬í•˜ì—¬ ë¬´í•œëŒ€ê¸° ë°©ì§€
                req.onerror = e => reject(new Error("IndexedDB Error"));
                req.onblocked = e => reject(new Error("DB Blocked"));
            });
        }

        function getDB(db, key) {
            return new Promise((resolve) => {
                try {
                    let tx = db.transaction(STORE_NAME, 'readonly');
                    let req = tx.objectStore(STORE_NAME).get(key);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve(null);
                } catch(e) { resolve(null); }
            });
        }

        function putDB(db, key, val) {
            return new Promise((resolve, reject) => {
                try {
                    let tx = db.transaction(STORE_NAME, 'readwrite');
                    tx.objectStore(STORE_NAME).put(val, key);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject();
                } catch(e) { reject(e); }
            });
        }

        // ğŸŒŸ 3. ì™„ë²½í•œ ìºì‹œ í­íŒŒ í•¨ìˆ˜
        function forceRefreshCache() {
            if (confirm("ì €ì¥ëœ ì—‘ì…€ ìºì‹œë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì˜¤ë¥˜ê°€ ë°œìƒí•  ë•Œ ëˆ„ë¥´ë©´ ìœ ìš©í•©ë‹ˆë‹¤)")) {
                try {
                    let req = indexedDB.deleteDatabase(DB_NAME);
                    req.onsuccess = () => { alert("ìºì‹œ ì‚­ì œ ì™„ë£Œ! ë°ì´í„°ë¥¼ ìƒˆë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤."); window.location.reload(); };
                    req.onerror = () => { alert("ìºì‹œ ì‚­ì œ ì‹¤íŒ¨. ë¸Œë¼ìš°ì € ì°½ì„ ê»ë‹¤ ì¼œì£¼ì„¸ìš”."); window.location.reload(); };
                    req.onblocked = () => { alert("ë‹¤ë¥¸ ëŒ€ì‹œë³´ë“œ íƒ­ì´ ì¼œì ¸ ìˆì–´ ì‚­ì œê°€ ì§€ì—°ë©ë‹ˆë‹¤. ë‹¤ë¥¸ íƒ­ì„ ëª¨ë‘ ë‹«ì•„ì£¼ì„¸ìš”!"); };
                } catch(e) {
                    window.location.reload();
                }
            }
        }

        function updateLoadingStatus(msg) {
            let el = document.getElementById('loadingText');
            if (el) el.innerText = msg;
            console.log(msg); // ë””ë²„ê¹…ìš©
        }

        function normArt(val) {
            if (val === undefined || val === null) return "";
            let str = String(val).trim();
            if (/^\d+$/.test(str)) return parseInt(str, 10).toString();
            return str;
        }

        function normPA(val) {
            if (val === undefined || val === null || val === "") return "";
            let str = String(val).trim().split(' ')[0]; 
            if (/^\d+$/.test(str)) {
                return str.padStart(4, '0');
            }
            return str;
        }

        function cleanData(dataArray, columnsToClean) {
            dataArray.forEach(row => {
                columnsToClean.forEach(col => {
                    if (row[col] !== undefined && row[col] !== "") {
                        let strVal = String(row[col]).replace(/[^0-9.-]/g, '');
                        let v = parseFloat(strVal);
                        if (!isNaN(v)) {
                            if (v > 10) { while (v > 1.01) v = v / 100; }
                            if (v > 1) v = 1;
                            if (v < 0) v = 0;
                            row[col] = v;
                        } else {
                            row[col] = 0;
                        }
                    }
                });
            });
            return dataArray;
        }

        function getYearWeek(dateObj, addDays = 0) {
            if (!dateObj || isNaN(dateObj.getTime())) return null;
            let d = new Date(dateObj.getTime());
            d.setDate(d.getDate() + addDays);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            let week1 = new Date(d.getFullYear(), 0, 4);
            let wk = 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            return d.getFullYear() + (wk < 10 ? '0' + wk : String(wk));
        }

        function parseExcelDate(val) {
            if (!val) return null;
            if (val instanceof Date) return val;
            if (typeof val === 'number') {
                let d = new Date(Math.round((val - 25569) * 86400 * 1000));
                d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
                return d;
            }
            if (typeof val === 'string') {
                let d = new Date(val.trim());
                if (!isNaN(d.getTime())) return d;
            }
            return null;
        }

        const getSheetData = (wb, name, useRaw = true) => {
            const sheet = wb.Sheets[name];
            return sheet ? XLSX.utils.sheet_to_json(sheet, { raw: useRaw, defval: "" }).map(row => {
                let newRow = {};
                for (let key in row) newRow[key.trim()] = row[key];
                return newRow;
            }) : [];
        };

        function buildSettingsUI() {
            let html = "";
            for(let i=0; i<7; i++) {
                let c = capaConfig[i];
                let tot = c.LF + c.HF + c.DD;
                html += `
                    <tr>
                        <td style="font-weight:bold;">${dayNames[i]}</td>
                        <td><input type="number" min="0" class="capa-input" id="capa_${i}_LF" value="${c.LF}" onchange="updateRowTotal(${i})"></td>
                        <td><input type="number" min="0" class="capa-input" id="capa_${i}_HF" value="${c.HF}" onchange="updateRowTotal(${i})"></td>
                        <td><input type="number" min="0" class="capa-input" id="capa_${i}_DD" value="${c.DD}" onchange="updateRowTotal(${i})"></td>
                        <td class="row-total" id="capa_${i}_tot">${tot}ëŒ€</td>
                    </tr>
                `;
            }
            document.getElementById('capaSettingsBody').innerHTML = html;
        }

        function updateRowTotal(dayIdx) {
            let lf = parseInt(document.getElementById(`capa_${dayIdx}_LF`).value) || 0;
            let hf = parseInt(document.getElementById(`capa_${dayIdx}_HF`).value) || 0;
            let dd = parseInt(document.getElementById(`capa_${dayIdx}_DD`).value) || 0;
            document.getElementById(`capa_${dayIdx}_tot`).innerText = (lf + hf + dd) + "ëŒ€";
        }

        function applySimulationSettings() {
            for(let i=0; i<7; i++) {
                capaConfig[i].LF = parseInt(document.getElementById(`capa_${i}_LF`).value) || 0;
                capaConfig[i].HF = parseInt(document.getElementById(`capa_${i}_HF`).value) || 0;
                capaConfig[i].DD = parseInt(document.getElementById(`capa_${i}_DD`).value) || 0;
            }
            document.getElementById('settingsView').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
            updateLoadingStatus("ìƒˆë¡œìš´ CAPA ì„¤ì •ìœ¼ë¡œ í(Queue)ë¥¼ ì¬ì •ë ¬í•˜ê³  ì˜ˆì¸¡ì„ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...");

            setTimeout(() => {
                runContainerSimulation();
                calculateProjections();
                initFilters(); 
                document.getElementById('viewLevel').value = 'store';
                updateSidebarUI(); 
                document.getElementById('loading').style.display = 'none';
            }, 100);
        }

        async function loadExcelFiles() {
            try {
                buildSettingsUI(); 
                updateLoadingStatus("ìºì‹œ DB ì—°ê²° ì¤‘...");

                let db = null;
                // ğŸŒŸ 4. íƒ€ì„ì•„ì›ƒ ë ˆì´ìŠ¤: 3ì´ˆ ì•ˆì— DB ëª»ì—´ë©´ ë¬´ì‹œí•˜ê³  ìŒ© ë‹¤ìš´ë¡œë“œ ì§„í–‰
                try {
                    db = await Promise.race([
                        openDB(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error("DB_TIMEOUT")), 3000))
                    ]);
                } catch(dbErr) {
                    console.warn("DB ì—°ê²° ì§€ì—°/ì‹¤íŒ¨. ìºì‹œë¥¼ ë¬´ì‹œí•˜ê³  ì—‘ì…€ì„ ê°•ì œë¡œ ìƒˆë¡œ ë°›ìŠµë‹ˆë‹¤.");
                }

                let useCache = false;
                let osaMod = 'unknown1', ordMod = 'unknown2';

                if (db) {
                    updateLoadingStatus("íŒŒì¼ ì—…ë°ì´íŠ¸ ì—¬ë¶€ í™•ì¸ ì¤‘...");
                    try {
                        let h1 = await Promise.race([fetch('./FY26 OSA.xlsx', { method: 'HEAD' }), new Promise((_, r) => setTimeout(r, 2000))]);
                        if(h1 && h1.headers) osaMod = h1.headers.get('Last-Modified') || h1.headers.get('ETag') || '1';
                        
                        let h2 = await Promise.race([fetch('./Order.xlsx', { method: 'HEAD' }), new Promise((_, r) => setTimeout(r, 2000))]);
                        if(h2 && h2.headers) ordMod = h2.headers.get('Last-Modified') || h2.headers.get('ETag') || '2';
                    } catch (e) { console.warn("í—¤ë” ì²´í¬ ìŠ¤í‚µ"); }

                    let cachedOsaMod = await getDB(db, 'osa_mod');
                    let cachedOrdMod = await getDB(db, 'ord_mod');

                    if (cachedOsaMod === osaMod && cachedOrdMod === ordMod) {
                        updateLoadingStatus("ì €ì¥ëœ ì—‘ì…€ ìºì‹œë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. (ì´ˆê³ ì† ë¡œë”© âš¡)");
                        excelData.STO_OSA = await getDB(db, 'STO_OSA');
                        excelData.HFB = await getDB(db, 'HFB');
                        excelData.PA = await getDB(db, 'PA'); 
                        excelData.Article_level = await getDB(db, 'Article_level');
                        excelData.AL010 = await getDB(db, 'AL010');
                        excelData.Table7 = await getDB(db, 'Table7');
                        excelData.SHP = await getDB(db, 'SHP');
                        
                        if (excelData.STO_OSA && excelData.AL010 && excelData.PA) {
                            useCache = true;
                        }
                    }
                }

                // ìºì‹œë¥¼ ëª»ì“°ë©´ ìƒˆë¡œ íŒŒì‹±
                if (!useCache) {
                    updateLoadingStatus("1/5: ìƒˆ ì—‘ì…€ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...");
                    const [res1, res2] = await Promise.all([fetch('./FY26 OSA.xlsx'), fetch('./Order.xlsx')]);
                    const ab1 = await res1.arrayBuffer();
                    const ab2 = await res2.arrayBuffer();

                    updateLoadingStatus("2/5: ê³¼ê±° ì‹¤ì (FY26 OSA) ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...");
                    await new Promise(r => setTimeout(r, 50));
                    const wb1 = XLSX.read(ab1, { type: 'array' });
                    
                    excelData.STO_OSA = cleanData(getSheetData(wb1, 'STO_OSA'), ['OSA']);
                    excelData.HFB = cleanData(getSheetData(wb1, 'HFB'), ['OSA']);
                    excelData.Article_level = cleanData(getSheetData(wb1, 'Article_level'), ['OSA']);

                    let paSheet = wb1.Sheets['PA'];
                    if(paSheet) {
                        let rawPa = XLSX.utils.sheet_to_json(paSheet, { header: "A", raw: true, defval: "" });
                        let mappedPa = [];
                        rawPa.slice(1).forEach(row => {
                            let yw = String(row['A'] || '').trim();
                            let bu = String(row['B'] || '').trim();
                            let paCode = normPA(row['D']);
                            let osaVal = row['E'];
                            if(yw && bu && paCode) {
                                mappedPa.push({ 'YW - Year Week': yw, 'BU - Business Unit': bu, 'PA': paCode, 'OSA': osaVal });
                            }
                        });
                        excelData.PA = cleanData(mappedPa, ['OSA']);
                    } else {
                        excelData.PA = [];
                    }

                    updateLoadingStatus("3/5: Order ë¬¼ë¥˜ ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (ì•½ 5ì´ˆ ì†Œìš”)");
                    await new Promise(r => setTimeout(r, 50));
                    const wb2 = XLSX.read(ab2, { type: 'array' });
                    excelData.AL010 = getSheetData(wb2, 'AL010');
                    excelData.Table7 = getSheetData(wb2, 'Table_7_Final');
                    let shpSheetName = wb2.SheetNames[3];
                    let rawShpData = XLSX.utils.sheet_to_json(wb2.Sheets[shpSheetName], { header: "A", raw: true, defval: "" });
                    excelData.SHP = rawShpData.slice(1);

                    if (db) {
                        updateLoadingStatus("4/5: ë°ì´í„°ë¥¼ ìºì‹œì— ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...");
                        await putDB(db, 'osa_mod', osaMod);
                        await putDB(db, 'ord_mod', ordMod);
                        await putDB(db, 'STO_OSA', excelData.STO_OSA);
                        await putDB(db, 'HFB', excelData.HFB);
                        await putDB(db, 'PA', excelData.PA);
                        await putDB(db, 'Article_level', excelData.Article_level);
                        await putDB(db, 'AL010', excelData.AL010);
                        await putDB(db, 'Table7', excelData.Table7);
                        await putDB(db, 'SHP', excelData.SHP);
                    }
                }

                updateLoadingStatus("5/5: ì¼ì¼ í•˜ì—­ CAPA ì‹œë®¬ë ˆì´í„° ë° ë¯¸ë˜ ì˜ˆì¸¡ ì¤‘...");
                await new Promise(r => setTimeout(r, 50));
                
                buildHierarchy();
                runContainerSimulation();
                calculateProjections();
                initFilters();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('viewLevel').value = 'settings';
                updateSidebarUI();

            } catch (error) {
                let msg = error.message || error.toString();
                document.getElementById('loading').innerHTML = `<span style="color:red;font-size:16px;">âŒ íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜ ë°œìƒ: ${msg}<br>ì—‘ì…€ íŒŒì¼ì´ ê°™ì€ í´ë”ì— ì˜ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</span>`;
                console.error(error);
            }
        }

        function buildHierarchy() {
            hierarchy = {};
            hfbNameMap = {};
            
            excelData.HFB.forEach(d => {
                let name = d['HFB Name - Home Furnishing Business Name'];
                if(name) {
                    let num = parseInt(name.split(' - ')[0]).toString();
                    hfbNameMap[num] = name;
                }
            });

            excelData.AL010.forEach(row => {
                let slValue = parseInt(row['SL']);
                if (isNaN(slValue) || slValue < 1 || slValue > 4) return;
                
                let storeId = String(row['MHS_ID']);
                let hfb = parseInt(row['HFB']).toString();
                let pa = normPA(row['PA']);
                let itemNo = normArt(row['ARTNO']);
                
                if (!hierarchy[storeId]) hierarchy[storeId] = {};
                if (!hierarchy[storeId][hfb]) hierarchy[storeId][hfb] = {};
                if (!hierarchy[storeId][hfb][pa]) hierarchy[storeId][hfb][pa] = new Set();
                
                hierarchy[storeId][hfb][pa].add(itemNo);
            });
        }

        function runContainerSimulation() {
            csmToSimulatedWeek = {};
            let containers = {};
            let today = new Date();
            today.setHours(0, 0, 0, 0);
            let simDate = new Date(today);
            let fixedByDate = {};

            excelData.SHP.forEach(row => {
                let storeCode = String(row['L'] || '').trim();
                if (!storeCode.includes("373")) return;

                let type = String(row['A'] || '').trim().toUpperCase();
                let cntrNo = String(row['D'] || '').trim();
                let csmId = String(row['F'] || '').trim();
                let actualArrDate = parseExcelDate(row['AJ']);
                let plannedArrDate = parseExcelDate(row['S']);
                let customsClearDate = parseExcelDate(row['AN']);
                let storeRecvDate = parseExcelDate(row['AT']);

                if (!cntrNo || !csmId) return;

                if (!containers[cntrNo]) {
                    containers[cntrNo] = {
                        type: type, csmList: [], fixedDate: null,
                        portArrivalDate: actualArrDate || plannedArrDate || null,
                        customsClearDate: customsClearDate || null
                    };
                }
                if (!containers[cntrNo].csmList.includes(csmId)) {
                    containers[cntrNo].csmList.push(csmId);
                }
                if (storeRecvDate) containers[cntrNo].fixedDate = storeRecvDate;
            });

            let queuedContainers = [];
            for (let cntr in containers) {
                let c = containers[cntr];
                if (c.fixedDate && c.fixedDate >= simDate) {
                    let dStr = c.fixedDate.toISOString().split('T')[0];
                    if (!fixedByDate[dStr]) fixedByDate[dStr] = { LF: 0, DD: 0, HF: 0 };
                    if (c.type === 'LF') fixedByDate[dStr].LF++;
                    else if (c.type === 'DD') fixedByDate[dStr].DD++;
                    else if (c.type === 'HF') fixedByDate[dStr].HF++;
                    let fw = getYearWeek(c.fixedDate);
                    c.csmList.forEach(csm => csmToSimulatedWeek[csm] = fw);
                } else if (c.portArrivalDate) {
                    queuedContainers.push(c);
                }
            }

            queuedContainers.sort((a, b) => a.portArrivalDate - b.portArrivalDate);
            let qIndex = 0;

            while (qIndex < queuedContainers.length && simDate.getTime() < today.getTime() + 90 * 86400000) {
                let dow = simDate.getDay(); 
                let baseCapa = capaConfig[dow] || {LF:0, HF:0, DD:0};
                let dailyMax = baseCapa.LF + baseCapa.HF + baseCapa.DD;

                let dStr = simDate.toISOString().split('T')[0];
                let daily = fixedByDate[dStr] || { LF: 0, DD: 0, HF: 0 };
                let totalDaily = daily.LF + daily.HF + daily.DD;

                let pendingLF = 0, pendingHF = 0, pendingDD = 0;
                for (let i = qIndex; i < queuedContainers.length; i++) {
                    let c = queuedContainers[i];
                    if (c.scheduled) continue;
                    if (c.portArrivalDate > simDate) break;
                    if (c.type === 'LF') pendingLF++;
                    else if (c.type === 'HF') pendingHF++;
                    else if (c.type === 'DD') pendingDD++;
                }

                if (pendingLF + pendingHF + pendingDD > 0) {
                    let slotLF = Math.max(0, baseCapa.LF - daily.LF);
                    let slotHF = Math.max(0, baseCapa.HF - daily.HF);
                    let slotDD = Math.max(0, baseCapa.DD - daily.DD);

                    let usedByLF = Math.min(slotLF, pendingLF);
                    let donateToHF = slotLF - usedByLF;
                    let totalHFSlot = slotHF + donateToHF;
                    let usedByHF = Math.min(totalHFSlot, pendingHF);
                    let donateToDD = totalHFSlot - usedByHF;
                    let totalDDSlot = slotDD + donateToDD;
                    let usedByDD = Math.min(totalDDSlot, pendingDD);

                    let remLF = usedByLF, remHF = usedByHF, remDD = usedByDD;
                    let scheduledToday = [];

                    for (let i = qIndex; i < queuedContainers.length && totalDaily < dailyMax; i++) {
                        let c = queuedContainers[i];
                        if (c.scheduled) continue;
                        if (c.portArrivalDate > simDate) break;

                        if (c.type === 'LF' && remLF > 0) {
                            c.scheduled = true; remLF--; totalDaily++; scheduledToday.push(c);
                        } else if (c.type === 'HF' && remHF > 0) {
                            c.scheduled = true; remHF--; totalDaily++; scheduledToday.push(c);
                        } else if (c.type === 'DD' && remDD > 0) {
                            c.scheduled = true; remDD--; totalDaily++; scheduledToday.push(c);
                        }
                    }
                    let currentSimWeek = getYearWeek(simDate);
                    scheduledToday.forEach(c => c.csmList.forEach(csm => csmToSimulatedWeek[csm] = currentSimWeek));
                }
                simDate.setDate(simDate.getDate() + 1);
                while (qIndex < queuedContainers.length && queuedContainers[qIndex].scheduled) qIndex++;
            }
        }

        function calculateProjections() {
            projectionData = { store: {}, hfb: {}, pa: {}, article: {}, weeks: [] };

            let allWeeks = [...new Set(excelData.STO_OSA.map(d => String(d['YW - Year Week'])).filter(w => w && w !== "undefined"))].sort();
            lastActualWeek = allWeeks[allWeeks.length - 1];

            let prevWeekArticleOSA = {};
            let activeStoreArticles = {};
            excelData.Article_level.forEach(d => {
                if (String(d['YW - Year Week']) === lastActualWeek) {
                    let storeId = String(d['BU - Business Unit']).split(' - ')[0];
                    let itemNo = normArt(d['Item Number']);
                    let osaVal = parseFloat(d['OSA']) || 0;
                    if (!prevWeekArticleOSA[storeId]) prevWeekArticleOSA[storeId] = {};
                    prevWeekArticleOSA[storeId][itemNo] = osaVal;
                    if (!activeStoreArticles[storeId]) activeStoreArticles[storeId] = new Set();
                    activeStoreArticles[storeId].add(itemNo);
                }
            });

            let y = parseInt(lastActualWeek.substring(0, 4));
            let w = parseInt(lastActualWeek.substring(4, 6));
            for (let i = 1; i <= 6; i++) {
                w++; if (w > 52) { y++; w = 1; }
                projectionData.weeks.push(y + (w < 10 ? '0' + w : '' + w));
            }
            let firstProjWeek = projectionData.weeks[0];

            let incoming = {};
            excelData.Table7.forEach(row => {
                let itemNo = normArt(row['ItemNo']);
                let csmId = String(row['Csm Id'] || '').trim();
                let qty = parseFloat(row['LatestQty']) || 0;
                if (!itemNo || qty <= 0) return;

                let targetWk = null;
                if (csmId && csmToSimulatedWeek[csmId]) {
                    targetWk = csmToSimulatedWeek[csmId];
                } else {
                    let mDate = parseExcelDate(row['Planned Receiving Date']);
                    let uDate = parseExcelDate(row['LatestRcvDate']);
                    if (mDate) targetWk = getYearWeek(mDate, 0);
                    else if (uDate) targetWk = getYearWeek(uDate, 7);
                    if (targetWk && targetWk <= lastActualWeek) targetWk = firstProjWeek;
                }

                if (targetWk && projectionData.weeks.includes(targetWk)) {
                    if (!incoming[itemNo]) incoming[itemNo] = {};
                    incoming[itemNo][targetWk] = (incoming[itemNo][targetWk] || 0) + qty;
                }
            });

            let todayDay = new Date().getDay();
            let elapsedDays = todayDay === 0 ? 7 : todayDay;
            let remainDays = 7 - elapsedDays;

            excelData.AL010.forEach(row => {
                let slValue = parseInt(row['SL']);
                if (isNaN(slValue) || slValue < 1 || slValue > 4) return;

                let storeId = String(row['MHS_ID']);
                let itemNo = normArt(row['ARTNO']);
                if (!activeStoreArticles[storeId] || !activeStoreArticles[storeId].has(itemNo)) return;

                let hfb = parseInt(row['HFB']).toString();
                let paCode = normPA(row['PA']); 
                
                let avgSales = parseFloat(row['AVGSALES']) || 0;
                let currentStock = parseFloat(row['AVAILABLESTOCK']) || 0;
                let originalStock = currentStock;

                if (!projectionData.article[storeId]) projectionData.article[storeId] = {};
                if (!projectionData.hfb[storeId]) projectionData.hfb[storeId] = {};
                if (!projectionData.hfb[storeId][hfb]) projectionData.hfb[storeId][hfb] = {};
                if (!projectionData.pa[storeId]) projectionData.pa[storeId] = {};
                if (!projectionData.pa[storeId][paCode]) projectionData.pa[storeId][paCode] = {};
                if (!projectionData.store[storeId]) projectionData.store[storeId] = {};

                let projOsaMap = {};

                projectionData.weeks.forEach((wk, index) => {
                    let inQty = (incoming[itemNo] && incoming[itemNo][wk]) ? incoming[itemNo][wk] : 0;
                    currentStock += inQty;

                    let osa = 0;
                    let salesToDeduct = avgSales;

                    if (index === 0) {
                        salesToDeduct = avgSales * (remainDays / 7);
                        let remainOsa = 0;
                        if (salesToDeduct <= 0) {
                            remainOsa = currentStock > 0 ? 1 : 0;
                        } else if (currentStock >= salesToDeduct) {
                            remainOsa = 1;
                        } else if (currentStock > 0) {
                            remainOsa = currentStock / salesToDeduct;
                        }

                        let pastOsa;
                        if (prevWeekArticleOSA[storeId] && prevWeekArticleOSA[storeId][itemNo] !== undefined) {
                            pastOsa = prevWeekArticleOSA[storeId][itemNo];
                        } else {
                            let pastSalesEstimate = avgSales * (elapsedDays / 7);
                            if (pastSalesEstimate <= 0) {
                                pastOsa = originalStock > 0 ? 1 : 0;
                            } else {
                                pastOsa = Math.min(1, Math.max(0, originalStock / pastSalesEstimate));
                            }
                        }
                        osa = ((elapsedDays * pastOsa) + (remainDays * remainOsa)) / 7;
                    } else {
                        if (avgSales <= 0) {
                            osa = currentStock > 0 ? 1 : 0;
                        } else if (currentStock >= avgSales) {
                            osa = 1;
                        } else if (currentStock > 0) {
                            osa = currentStock / avgSales;
                        } else {
                            osa = 0;
                        }
                    }

                    projOsaMap[wk] = Math.min(1, Math.max(0, osa));
                    currentStock = Math.max(0, currentStock - salesToDeduct);

                    if (!projectionData.hfb[storeId][hfb][wk]) projectionData.hfb[storeId][hfb][wk] = { sum: 0, cnt: 0 };
                    projectionData.hfb[storeId][hfb][wk].sum += projOsaMap[wk];
                    projectionData.hfb[storeId][hfb][wk].cnt++;

                    if (!projectionData.pa[storeId][paCode][wk]) projectionData.pa[storeId][paCode][wk] = { sum: 0, cnt: 0 };
                    projectionData.pa[storeId][paCode][wk].sum += projOsaMap[wk];
                    projectionData.pa[storeId][paCode][wk].cnt++;

                    if (!projectionData.store[storeId][wk]) projectionData.store[storeId][wk] = { sum: 0, cnt: 0 };
                    projectionData.store[storeId][wk].sum += projOsaMap[wk];
                    projectionData.store[storeId][wk].cnt++;
                });

                projectionData.article[storeId][itemNo] = projOsaMap;
            });
        }

        function getVisibleWeeks() {
            let fromWk = document.getElementById('fromWeek').value;
            let toWk = document.getElementById('toWeek').value;
            let allWeeks = [...new Set(excelData.STO_OSA.map(d => String(d['YW - Year Week'])))].sort();
            let totalWeeks = allWeeks.concat(projectionData.weeks);
            return totalWeeks.filter(w => w >= fromWk && w <= toWk).sort(); 
        }

        function updateSidebarUI() {
            const level = document.getElementById('viewLevel').value;
            
            document.getElementById('settingsView').style.display = (level === 'settings') ? 'block' : 'none';
            document.getElementById('dashboard').style.display = (level !== 'settings') ? 'block' : 'none';
            
            document.getElementById('storeFilter').style.display = (level !== 'store' && level !== 'settings') ? 'block' : 'none';
            document.getElementById('hierarchyFilters').style.display = (level === 'pa' || level === 'article') ? 'block' : 'none';
            document.getElementById('articleSearchFilter').style.display = (level === 'article') ? 'block' : 'none';
            document.getElementById('paFilterContainer').style.display = (level === 'pa' || level === 'article') ? 'block' : 'none';
            
            if (level === 'pa' || level === 'article') {
                populateHfbDropdown(); 
            } else if (level !== 'settings') {
                updateView();
            }
        }

        function populateHfbDropdown() {
            let storeCode = document.getElementById('storeSelect').value.split(' - ')[0];
            let hfbs = Object.keys(hierarchy[storeCode] || {}).sort((a,b) => parseInt(a)-parseInt(b));
            
            let hfbSel = document.getElementById('hfbSelect');
            hfbSel.innerHTML = hfbs.map(h => {
                let label = hfbNameMap[h] ? `${h} - ${hfbNameMap[h]}` : `HFB ${h}`;
                return `<option value="${h}">${label}</option>`;
            }).join('');
            
            onHfbChange();
        }

        function onHfbChange() {
            let storeCode = document.getElementById('storeSelect').value.split(' - ')[0];
            let hfb = document.getElementById('hfbSelect').value;
            let pas = Object.keys(hierarchy[storeCode]?.[hfb] || {}).sort();
            
            let paSel = document.getElementById('paSelect');
            let level = document.getElementById('viewLevel').value;
            
            let html = '';
            if (level === 'pa') {
                html += '<option value="ALL">-- í•´ë‹¹ HFBì˜ ì „ì²´ PA ë³´ê¸° --</option>';
            } else if (level === 'article') {
                html += '<option value="ALL">-- í•´ë‹¹ HFBì˜ ì „ì²´ ì œí’ˆ ë³´ê¸° --</option>';
            }
            
            html += pas.map(p => `<option value="${p}">PA ${p}</option>`).join('');
            paSel.innerHTML = html;
            
            updateView();
        }

        function initFilters() {
            let allWeeks = [...new Set(excelData.STO_OSA.map(d => String(d['YW - Year Week'])))].sort();
            let totalWeeks = allWeeks.concat(projectionData.weeks);
            const fromSelect = document.getElementById('fromWeek');
            const toSelect = document.getElementById('toWeek');
            
            const weekOptions = totalWeeks.map(w => `<option value="${w}">${w}${w > lastActualWeek ? ' (Proj)' : ''}</option>`).join('');
            fromSelect.innerHTML = weekOptions;
            toSelect.innerHTML = weekOptions;
            
            if (totalWeeks.length > 0) {
                fromSelect.value = allWeeks[0];
                toSelect.value = totalWeeks[totalWeeks.length - 1];
            }
            
            const stores = [...new Set(excelData.STO_OSA.map(d => d['BU - Business Unit']))].sort();
            const storeSelect = document.getElementById('storeSelect');
            storeSelect.innerHTML = stores.map(s => `<option value="${s}" ${s.includes('373') ? 'selected' : ''}>${s}</option>`).join('');
        }

        function handleEnter(e) { if (e.key === 'Enter') updateView(); }

        function updateView() {
            const level = document.getElementById('viewLevel').value;
            if(level === 'settings') return;

            const store = document.getElementById('storeSelect').value;
            const storeCode = store.split(' - ')[0];

            if (level === 'store') {
                document.getElementById('mainTitle').innerText = '1. Store Overview (Benchmarking)';
                document.getElementById('subTitle').innerText = 'ëª¨ë“  ìŠ¤í† ì–´ì˜ ë°ì´í„°ì…ë‹ˆë‹¤. í•˜ë‹¨ ë²”ë¡€ë¥¼ í´ë¦­í•˜ì—¬ ì›í•˜ëŠ” ìŠ¤í† ì–´ë§Œ ë¹„êµí•´ë³´ì„¸ìš”.';
                renderStoreData();
            } else if (level === 'hfb') {
                document.getElementById('mainTitle').innerText = `2. HFB Level (${storeCode})`;
                document.getElementById('subTitle').innerText = 'í•´ë‹¹ ìŠ¤í† ì–´ì˜ ì „ì²´ HFBì…ë‹ˆë‹¤. í•˜ë‹¨ ë²”ë¡€ë¥¼ í´ë¦­í•˜ì—¬ ë¹„êµí•´ë³´ì„¸ìš”.';
                renderHFBData(store);
            } else if (level === 'pa') {
                let hfbName = document.getElementById('hfbSelect').options[document.getElementById('hfbSelect').selectedIndex]?.text || '';
                document.getElementById('mainTitle').innerText = `3. PA Level (${storeCode})`;
                document.getElementById('subTitle').innerText = `[${hfbName}] ê·¸ë£¹ì— ì†í•œ PA íŠ¸ë Œë“œì…ë‹ˆë‹¤.`;
                renderPAData(store);
            } else if (level === 'article') {
                document.getElementById('mainTitle').innerText = `4. Article Level (${storeCode})`;
                document.getElementById('subTitle').innerText = `ì œí’ˆ ë²ˆí˜¸ë¥¼ ê²€ìƒ‰í•˜ê±°ë‚˜, ì¢Œì¸¡ í•„í„°ì—ì„œ HFB/PAë¥¼ ì„ íƒí•˜ì—¬ ì œí’ˆêµ°ì„ í™•ì¸í•˜ì„¸ìš”.`;
                renderArticleData(store);
            }
        }

        function renderStoreData() {
            let stores = [...new Set(excelData.STO_OSA.map(d => d['BU - Business Unit']))].sort();
            let visWeeks = getVisibleWeeks();
            let traces = [], tableRows = [];
            let allY = [];
            
            stores.forEach(st => {
                let storeCode = st.split(' - ')[0];
                let stActuals = excelData.STO_OSA.filter(d => d['BU - Business Unit'] === st);
                
                let osaMap = {};
                stActuals.forEach(d => { osaMap[String(d['YW - Year Week'])] = parseFloat(d['OSA']); });
                
                if (projectionData.store[storeCode]) {
                    for (let w in projectionData.store[storeCode]) {
                        let cnt = projectionData.store[storeCode][w].cnt;
                        osaMap[w] = cnt > 0 ? projectionData.store[storeCode][w].sum / cnt : null;
                    }
                }

                let actX = [], actY = [], projX = [], projY = [], lastX = null, lastY = null;
                let rowData = [st];
                let hasData = false;

                visWeeks.forEach(w => {
                    let val = osaMap[w];
                    if (val !== undefined && val !== null) {
                        hasData = true;
                        rowData.push((val * 100).toFixed(1) + '%');
                        allY.push(val);
                        if (w > lastActualWeek) {
                            if (projX.length === 0 && lastX) { projX.push(lastX); projY.push(lastY); }
                            projX.push(w); projY.push(val);
                        } else {
                            actX.push(w); actY.push(val); lastX = w; lastY = val;
                        }
                    } else {
                        rowData.push('-');
                    }
                });

                if (hasData) {
                    traces.push({ x: actX, y: actY, type: 'scatter', mode: 'lines+markers', name: st, legendgroup: st });
                    if (projX.length > 0) traces.push({ x: projX, y: projY, type: 'scatter', mode: 'lines+markers', line: { dash: 'dot', width: 2 }, name: st + ' (Proj)', showlegend: false, legendgroup: st });
                    tableRows.push(rowData);
                }
            });

            let minY = allY.length > 0 ? Math.min(...allY) : 0;
            Plotly.newPlot('chartDiv', traces, {
                title: 'All Stores - Weekly OSA Trend', xaxis: { type: 'category' },
                yaxis: { tickformat: '.1%', range: [Math.max(0, minY - 0.05), 1.05] }, margin: { t: 40, b: 120 }, legend: { orientation: 'h', yanchor: 'top', y: -0.15 }
            });
            drawTable(['Store'].concat(visWeeks), tableRows, visWeeks.map(w => w > lastActualWeek));
        }

        function renderHFBData(store) {
            let storeCode = store.split(' - ')[0];
            let actData = excelData.HFB.filter(d => d['BU - Business Unit'] === store);
            let hfbs = [...new Set(actData.map(d => d['HFB Name - Home Furnishing Business Name']))].sort();
            
            let visWeeks = getVisibleWeeks();
            let traces = [], tableRows = [], allY = [];

            hfbs.forEach(hfb => {
                let hfbNumStr = parseInt(hfb.split(' - ')[0]).toString();
                let hfbActuals = actData.filter(d => d['HFB Name - Home Furnishing Business Name'] === hfb);
                
                let osaMap = {};
                hfbActuals.forEach(d => { osaMap[String(d['YW - Year Week'])] = parseFloat(d['OSA']); });
                if (projectionData.hfb[storeCode] && projectionData.hfb[storeCode][hfbNumStr]) {
                    for (let w in projectionData.hfb[storeCode][hfbNumStr]) {
                        let cnt = projectionData.hfb[storeCode][hfbNumStr][w].cnt;
                        osaMap[w] = cnt > 0 ? projectionData.hfb[storeCode][hfbNumStr][w].sum / cnt : null;
                    }
                }

                let actX = [], actY = [], projX = [], projY = [], lastX = null, lastY = null;
                let rowData = [hfb];
                let hasData = false;

                visWeeks.forEach(w => {
                    let val = osaMap[w];
                    if (val !== undefined && val !== null) {
                        hasData = true;
                        rowData.push((val * 100).toFixed(1) + '%');
                        allY.push(val);
                        if (w > lastActualWeek) {
                            if (projX.length === 0 && lastX) { projX.push(lastX); projY.push(lastY); }
                            projX.push(w); projY.push(val);
                        } else {
                            actX.push(w); actY.push(val); lastX = w; lastY = val;
                        }
                    } else {
                        rowData.push('-');
                    }
                });

                if (hasData) {
                    traces.push({ x: actX, y: actY, type: 'scatter', mode: 'lines+markers', name: hfb, legendgroup: hfb });
                    if (projX.length > 0) traces.push({ x: projX, y: projY, type: 'scatter', mode: 'lines+markers', line: { dash: 'dot' }, name: hfb, showlegend: false, legendgroup: hfb });
                    tableRows.push(rowData);
                }
            });

            let minY = allY.length > 0 ? Math.min(...allY) : 0;
            Plotly.newPlot('chartDiv', traces, {
                title: 'All HFBs in ' + storeCode, xaxis: { type: 'category' },
                yaxis: { tickformat: '.1%', range: [Math.max(0, minY - 0.05), 1.05] }, margin: { t: 40, b: 120 }, legend: { orientation: 'h', yanchor: 'top', y: -0.15 }
            });
            drawTable(['HFB Name'].concat(visWeeks), tableRows, visWeeks.map(w => w > lastActualWeek));
        }

        function renderPAData(store) {
            let storeCode = store.split(' - ')[0];
            let hfb = document.getElementById('hfbSelect').value;
            let selectedPa = document.getElementById('paSelect').value;
            
            let targetPAs = selectedPa === 'ALL' ? Object.keys(hierarchy[storeCode]?.[hfb] || {}).sort() : [selectedPa];
            
            let visWeeks = getVisibleWeeks();
            let traces = [], tableRows = [], allY = [];
            
            targetPAs.forEach(pa => {
                let paActuals = excelData.PA.filter(d => String(d['BU - Business Unit']).includes(storeCode) && normPA(d['PA']) === pa);
                
                let osaMap = {};
                paActuals.forEach(d => { osaMap[String(d['YW - Year Week'])] = parseFloat(d['OSA']); });
                
                if (projectionData.pa[storeCode] && projectionData.pa[storeCode][pa]) {
                    for (let w in projectionData.pa[storeCode][pa]) {
                        let cnt = projectionData.pa[storeCode][pa][w].cnt;
                        osaMap[w] = cnt > 0 ? projectionData.pa[storeCode][pa][w].sum / cnt : null;
                    }
                }

                let actX = [], actY = [], projX = [], projY = [], lastX = null, lastY = null;
                let rowData = [`PA ${pa}`];
                let hasData = false;

                visWeeks.forEach(w => {
                    let val = osaMap[w];
                    if (val !== undefined && val !== null) {
                        hasData = true;
                        rowData.push((val * 100).toFixed(1) + '%');
                        allY.push(val);
                        if (w > lastActualWeek) {
                            if (projX.length === 0 && lastX) { projX.push(lastX); projY.push(lastY); }
                            projX.push(w); projY.push(val);
                        } else {
                            actX.push(w); actY.push(val); lastX = w; lastY = val;
                        }
                    } else {
                        rowData.push('-');
                    }
                });

                if (hasData) {
                    traces.push({ x: actX, y: actY, type: 'scatter', mode: 'lines+markers', name: pa, legendgroup: pa });
                    if (projX.length > 0) traces.push({ x: projX, y: projY, type: 'scatter', mode: 'lines+markers', line: { dash: 'dot' }, name: pa, showlegend: false, legendgroup: pa });
                    tableRows.push(rowData);
                }
            });

            let minY = allY.length > 0 ? Math.min(...allY) : 0;
            Plotly.newPlot('chartDiv', traces, {
                title: selectedPa === 'ALL' ? `All PAs in HFB ${hfb}` : `PA ${selectedPa} Trend`,
                xaxis: { type: 'category' }, yaxis: { tickformat: '.1%', range: [Math.max(0, minY - 0.05), 1.05] },
                margin: { t: 40, b: 120 }, legend: { orientation: 'h', yanchor: 'top', y: -0.15 }
            });
            drawTable(['PA Number'].concat(visWeeks), tableRows, visWeeks.map(w => w > lastActualWeek));
        }

        function renderArticleData(store) {
            let storeCode = store.split(' - ')[0];
            let searchInput = document.getElementById('articleInput').value.trim();
            let hfb = document.getElementById('hfbSelect').value;
            let pa = document.getElementById('paSelect').value;
            
            let targetArticles = [];
            
            if (searchInput) {
                targetArticles = [normArt(searchInput)];
            } else if (hfb) {
                if (pa === 'ALL') {
                    let paObj = hierarchy[storeCode]?.[hfb] || {};
                    for(let p in paObj) paObj[p].forEach(a => targetArticles.push(a));
                } else if (pa) {
                    let set = hierarchy[storeCode]?.[hfb]?.[pa];
                    if(set) targetArticles = Array.from(set);
                }
            }

            if (targetArticles.length === 0) { 
                Plotly.newPlot('chartDiv', []); drawTable([], []); return; 
            }

            let visWeeks = getVisibleWeeks();
            let tableRows = [];
            let allY = [];
            let groupSum = {}, groupCnt = {};

            targetArticles.forEach(itemNo => {
                let actuals = excelData.Article_level.filter(d => d['BU - Business Unit'].includes(storeCode) && normArt(d['Item Number']) === itemNo);
                
                let osaMap = {};
                actuals.forEach(d => { osaMap[String(d['YW - Year Week'])] = parseFloat(d['OSA']); });
                if (projectionData.article[storeCode] && projectionData.article[storeCode][itemNo]) {
                    Object.assign(osaMap, projectionData.article[storeCode][itemNo]);
                }

                let rowData = [itemNo];
                let hasData = false;
                
                visWeeks.forEach(w => {
                    let val = osaMap[w];
                    if (val !== undefined && val !== null) {
                        hasData = true;
                        rowData.push((val * 100).toFixed(1) + '%');
                        if (!groupSum[w]) { groupSum[w] = 0; groupCnt[w] = 0; }
                        groupSum[w] += val;
                        groupCnt[w]++;
                    } else {
                        rowData.push('-');
                    }
                });

                if (hasData) tableRows.push(rowData);
            });

            let traces = [];
            if (searchInput && targetArticles.length === 1) {
                let itemNo = targetArticles[0];
                let actuals = excelData.Article_level.filter(d => d['BU - Business Unit'].includes(storeCode) && normArt(d['Item Number']) === itemNo);
                let osaMap = {};
                actuals.forEach(d => { osaMap[String(d['YW - Year Week'])] = parseFloat(d['OSA']); });
                if (projectionData.article[storeCode] && projectionData.article[storeCode][itemNo]) {
                    Object.assign(osaMap, projectionData.article[storeCode][itemNo]);
                }

                let actX = [], actY = [], projX = [], projY = [], lastX = null, lastY = null;
                visWeeks.forEach(w => {
                    let val = osaMap[w];
                    if (val !== undefined && val !== null) {
                        allY.push(val);
                        if (w > lastActualWeek) {
                            if (projX.length === 0 && lastX) { projX.push(lastX); projY.push(lastY); }
                            projX.push(w); projY.push(val);
                        } else {
                            actX.push(w); actY.push(val); lastX = w; lastY = val;
                        }
                    }
                });
                traces.push({ x: actX, y: actY, type: 'scatter', mode: 'lines+markers', name: 'OSA', line: { color: '#0058a3' } });
                if (projX.length > 0) traces.push({ x: projX, y: projY, type: 'scatter', mode: 'lines+markers', name: 'OSA (Proj)', line: { color: '#0058a3', dash: 'dot' } });
                
                let minY = allY.length > 0 ? Math.min(...allY) : 0;
                Plotly.newPlot('chartDiv', traces, { title: `Item: ${itemNo} - Weekly OSA`, xaxis: { type: 'category' }, yaxis: { tickformat: '.0%', range: [Math.max(0, minY - 0.05), 1.05] }, margin: { t: 40, b: 120 }, legend: { orientation: 'h', yanchor: 'top', y: -0.15 } });
            } else {
                let actX = [], actY = [], projX = [], projY = [], lastX = null, lastY = null;
                visWeeks.forEach(w => {
                    if (groupCnt[w] > 0) {
                        let avgVal = groupSum[w] / groupCnt[w];
                        allY.push(avgVal);
                        if (w > lastActualWeek) {
                            if (projX.length === 0 && lastX) { projX.push(lastX); projY.push(lastY); }
                            projX.push(w); projY.push(avgVal);
                        } else {
                            actX.push(w); actY.push(avgVal); lastX = w; lastY = avgVal;
                        }
                    }
                });
                traces.push({ x: actX, y: actY, type: 'scatter', mode: 'lines+markers', name: 'Avg Group OSA', line: { color: '#0058a3' } });
                if (projX.length > 0) traces.push({ x: projX, y: projY, type: 'scatter', mode: 'lines+markers', name: 'Avg OSA (Proj)', line: { color: '#0058a3', dash: 'dot' } });
                
                let title = pa === 'ALL' ? `HFB ${hfb} Total Items Average` : `PA ${pa} Items Average`;
                let minY = allY.length > 0 ? Math.min(...allY) : 0;
                Plotly.newPlot('chartDiv', traces, { title: title, xaxis: { type: 'category' }, yaxis: { tickformat: '.1%', range: [Math.max(0, minY - 0.05), 1.05] }, margin: { t: 40, b: 120 }, legend: { orientation: 'h', yanchor: 'top', y: -0.15 } });
            }

            drawTable(['Article No.'].concat(visWeeks), tableRows, visWeeks.map(w => w > lastActualWeek));
        }

        function drawTable(headers, rows, isProjArray) {
            if (headers.length === 0) { document.getElementById('tableHead').innerHTML = ""; document.getElementById('tableBody').innerHTML = ""; return; }
            document.getElementById('tableHead').innerHTML = headers.map((h, i) => {
                let isProj = (i > 0 && isProjArray && isProjArray[i-1]) ? true : false;
                return `<th${isProj ? ' class="proj-col"' : ''}>${h}</th>`;
            }).join('');
            document.getElementById('tableBody').innerHTML = rows.map(r => `<tr>${r.map((c, i) => {
                let isProj = (i > 0 && isProjArray && isProjArray[i-1]) ? true : false;
                return `<td${isProj ? ' class="proj-cell"' : ''}>${c}</td>`;
            }).join('')}</tr>`).join('');
        }

        window.onload = loadExcelFiles;
    </script>
</body>
</html>
