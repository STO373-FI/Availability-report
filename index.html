<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STO373 Availability report</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f3f4f6; display: flex; color: #333; }
        .sidebar { width: 260px; background-color: #003399; color: white; padding: 20px; height: 100vh; position: fixed; box-sizing: border-box; }
        .sidebar h2 { font-size: 20px; margin-bottom: 30px; border-bottom: 2px solid #ffcc00; padding-bottom: 10px; }
        .sidebar label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; color: #ffd100; }
        .sidebar select, .sidebar input, .sidebar button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: none; background-color: white; color: #333; font-weight: bold; box-sizing: border-box; }
        .sidebar button { background-color: #ffcc00; color: #003399; cursor: pointer; margin-top: 10px; }
        .sidebar button:hover { background-color: #ffd633; }
        
        .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); box-sizing: border-box; }
        .header-title { font-size: 28px; font-weight: bold; margin-bottom: 5px; color: #003399; }
        .header-desc { font-size: 14px; color: #666; margin-bottom: 20px; }
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .table-container { overflow-x: auto; white-space: nowrap; }
        table { border-collapse: collapse; margin-top: 10px; font-size: 13px; text-align: center; width: 100%; }
        th, td { padding: 10px 15px; border: 1px solid #ddd; }
        th { background-color: #f8f9fa; color: #333; font-weight: bold; }
        td:first-child, th:first-child { font-weight: bold; background-color: #eef2f5; text-align: left; position: sticky; left: 0; } /* ì²« ì—´ ê³ ì • */
        
        #loading { color: #d9534f; font-weight: bold; font-size: 16px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>ğŸ“Š Availability Report</h2>
        
        <label>1. View Level</label>
        <select id="viewLevel" onchange="updateView()">
            <option value="store">1. Store Overview</option>
            <option value="hfb">2. HFB Level</option>
            <option value="article">3. Article Level</option>
        </select>

        <div id="storeFilter" style="display: none;">
            <label>2. Select Store</label>
            <select id="storeSelect" onchange="updateView()">
                <option value="Loading...">Loading...</option>
            </select>
        </div>

        <div id="articleFilter" style="display: none;">
            <label>3. Search Article</label>
            <input type="text" id="articleInput" placeholder="ex) 157717" onkeypress="handleEnter(event)">
            <button onclick="updateView()">ğŸ” Search</button>
        </div>
    </div>

    <div class="main-content">
        <div class="header-title" id="mainTitle">Store Overview</div>
        <div class="header-desc" id="subTitle">ìš°ì¸¡ ë²”ë¡€(Legend)ë¥¼ í´ë¦­í•˜ì—¬ ì›í•˜ëŠ” ì„ ë§Œ ì¼œê³  ëŒ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <div id="loading">ë°ì´í„°(FY26 OSA.xlsx)ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>
        
        <div id="dashboard" style="display: none;">
            <div class="card">
                <div id="chartDiv" style="width:100%; height:450px;"></div>
            </div>
            
            <div class="card">
                <h3 style="margin-top:0; color:#333; font-size:18px;">Data Table</h3>
                <div class="table-container">
                    <table id="dataTable">
                        <thead><tr id="tableHead"></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let excelData = {}; 

        async function loadExcelFile() {
            try {
                const response = await fetch('./FY26 OSA.xlsx');
                if (!response.ok) throw new Error("File not found");
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                const getSheetData = (sheetName) => {
                    const sheet = workbook.Sheets[sheetName];
                    if(!sheet) return [];
                    return XLSX.utils.sheet_to_json(sheet, { defval: "" }).map(row => {
                        let newRow = {};
                        for (let key in row) newRow[key.trim()] = row[key];
                        return newRow;
                    });
                };

                excelData.STO_OSA = getSheetData('STO_OSA');
                excelData.HFB = getSheetData('HFB');
                excelData.Article_level = getSheetData('Article_level');

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

                initFilters();
            } catch (error) {
                document.getElementById('loading').innerText = "ì˜¤ë¥˜: 'FY26 OSA.xlsx' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                console.error(error);
            }
        }

        function initFilters() {
            const stores = [...new Set(excelData.STO_OSA.map(d => d['BU - Business Unit']))].sort();
            const storeSelect = document.getElementById('storeSelect');
            storeSelect.innerHTML = stores.map(s => `<option value="${s}" ${s.includes('373') ? 'selected' : ''}>${s}</option>`).join('');
            updateView();
        }

        function handleEnter(e) {
            if (e.key === 'Enter') updateView();
        }

        function updateView() {
            const level = document.getElementById('viewLevel').value;
            const store = document.getElementById('storeSelect').value;
            
            // í•„í„° UI ì œì–´
            document.getElementById('storeFilter').style.display = (level === 'hfb' || level === 'article') ? 'block' : 'none';
            document.getElementById('articleFilter').style.display = (level === 'article') ? 'block' : 'none';

            if (level === 'store') {
                document.getElementById('mainTitle').innerText = `1. Store Overview (Benchmarking)`;
                document.getElementById('subTitle').innerText = "ëª¨ë“  ìŠ¤í† ì–´ì˜ ë°ì´í„°ì…ë‹ˆë‹¤. ìš°ì¸¡ ë²”ë¡€ë¥¼ í´ë¦­í•˜ì—¬ ì›í•˜ëŠ” ìŠ¤í† ì–´ë§Œ ë¹„êµí•´ë³´ì„¸ìš”.";
                renderStoreData();
            } else if (level === 'hfb') {
                document.getElementById('mainTitle').innerText = `2. HFB Level (${store})`;
                document.getElementById('subTitle').innerText = "í•´ë‹¹ ìŠ¤í† ì–´ì˜ ëª¨ë“  HFB ë°ì´í„°ì…ë‹ˆë‹¤. ìš°ì¸¡ ë²”ë¡€ë¥¼ í´ë¦­í•˜ì—¬ ì›í•˜ëŠ” HFBë§Œ ë¹„êµí•´ë³´ì„¸ìš”.";
                renderHFBData(store);
            } else if (level === 'article') {
                document.getElementById('mainTitle').innerText = `3. Article Level (${store})`;
                document.getElementById('subTitle').innerText = "ì¢Œì¸¡ì—ì„œ ì œí’ˆ ë²ˆí˜¸ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”. (ì˜ˆ: 157717)";
                renderArticleData(store);
            }
        }

        // 1. ëª¨ë“  ìŠ¤í† ì–´ ë²¤ì¹˜ë§ˆí‚¹
        function renderStoreData() {
            let validData = excelData.STO_OSA.filter(d => d['OSA'] !== "" && !isNaN(parseFloat(d['OSA'])));
            let weeks = [...new Set(validData.map(d => String(d['YW - Year Week'])))].sort();
            let stores = [...new Set(validData.map(d => d['BU - Business Unit']))].sort();

            let traces = [];
            let rows = [];

            stores.forEach(st => {
                let stData = validData.filter(d => d['BU - Business Unit'] === st).sort((a,b) => a['YW - Year Week'] - b['YW - Year Week']);
                
                // ì°¨íŠ¸ íŠ¸ë ˆì´ìŠ¤ ì¶”ê°€
                traces.push({
                    x: stData.map(d => String(d['YW - Year Week'])), 
                    y: stData.map(d => parseFloat(d['OSA'])),
                    type: 'scatter', mode: 'lines+markers', name: st
                });

                // í…Œì´ë¸” í–‰ êµ¬ì„± (ì£¼ì°¨ë³„ë¡œ ë§¤í•‘)
                let rowData = [st];
                weeks.forEach(w => {
                    let match = stData.find(d => String(d['YW - Year Week']) === w);
                    rowData.push(match ? (parseFloat(match['OSA']) * 100).toFixed(1) + '%' : '-');
                });
                rows.push(rowData);
            });

            Plotly.newPlot('chartDiv', traces, { 
                title: 'All Stores - Weekly OSA Trend', 
                xaxis: { type: 'category' }, 
                yaxis: { tickformat: '.1%', range: [0.8, 1.05] }, margin: { t: 40, b: 40 }
            });

            drawTable(['Store'].concat(weeks), rows);
        }

        // 2. ìŠ¤í† ì–´ ë‚´ ëª¨ë“  HFB ë²¤ì¹˜ë§ˆí‚¹
        function renderHFBData(store) {
            let validData = excelData.HFB.filter(d => d['BU - Business Unit'] === store && d['OSA'] !== "" && !isNaN(parseFloat(d['OSA'])));
            let weeks = [...new Set(validData.map(d => String(d['YW - Year Week'])))].sort();
            let hfbs = [...new Set(validData.map(d => d['HFB Name - Home Furnishing Business Name']))].sort();

            let traces = [];
            let rows = [];

            hfbs.forEach(hfb => {
                let hData = validData.filter(d => d['HFB Name - Home Furnishing Business Name'] === hfb).sort((a,b) => a['YW - Year Week'] - b['YW - Year Week']);
                
                traces.push({
                    x: hData.map(d => String(d['YW - Year Week'])), 
                    y: hData.map(d => parseFloat(d['OSA'])),
                    type: 'scatter', mode: 'lines+markers', name: hfb
                });

                let rowData = [hfb];
                weeks.forEach(w => {
                    let match = hData.find(d => String(d['YW - Year Week']) === w);
                    rowData.push(match ? (parseFloat(match['OSA']) * 100).toFixed(1) + '%' : '-');
                });
                rows.push(rowData);
            });

            Plotly.newPlot('chartDiv', traces, { 
                title: `All HFBs in ${store} - OSA Trend`, 
                xaxis: { type: 'category' }, 
                yaxis: { tickformat: '.1%', range: [0.7, 1.05] } 
            });

            drawTable(['HFB Name'].concat(weeks), rows);
        }

        // 3. Article ê²€ìƒ‰ ê²°ê³¼
        function renderArticleData(store) {
            const itemNo = document.getElementById('articleInput').value.trim();
            
            if(!itemNo) {
                Plotly.newPlot('chartDiv', []);
                drawTable([], []);
                return;
            }
            
            let data = excelData.Article_level.filter(d => 
                d['BU - Business Unit'] === store && String(d['Item Number']) === itemNo &&
                d['OSA'] !== "" && !isNaN(parseFloat(d['OSA']))
            ).sort((a,b) => a['YW - Year Week'] - b['YW - Year Week']);
            
            if (data.length === 0) {
                alert(`"${itemNo}" ì— í•´ë‹¹í•˜ëŠ” ì œí’ˆ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nìŠ¤í† ì–´ì™€ ì œí’ˆ ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                return;
            }

            const weeks = data.map(d => String(d['YW - Year Week']));
            const osas = data.map(d => parseFloat(d['OSA']));
            const isas = data.map(d => parseFloat(d['ISA']));
            const artName = data[0]['artname'];

            document.getElementById('mainTitle').innerText = `3. Article Level (${store}) - [${itemNo}] ${artName}`;

            Plotly.newPlot('chartDiv', [
                { x: weeks, y: osas, type: 'scatter', mode: 'lines+markers', name: 'OSA', line: {color: '#0058a3'} },
                { x: weeks, y: isas, type: 'scatter', mode: 'lines+markers', name: 'ISA', line: {color: '#ff9900'} }
            ], { 
                title: `Item: ${itemNo} (${artName}) - OSA vs ISA`, 
                xaxis: { type: 'category' }, 
                yaxis: { tickformat: '.0%', range: [0, 1.05] } 
            });

            const headers = ['Metric'].concat(weeks);
            const osaRow = ['OSA %'].concat(osas.map(v => (v * 100).toFixed(1) + '%'));
            const isaRow = ['ISA %'].concat(isas.map(v => (v * 100).toFixed(1) + '%'));
            
            drawTable(headers, [osaRow, isaRow]);
        }

        function drawTable(headers, rows) {
            if(headers.length === 0) {
                document.getElementById('tableHead').innerHTML = "";
                document.getElementById('tableBody').innerHTML = "";
                return;
            }
            document.getElementById('tableHead').innerHTML = headers.map(h => `<th>${h}</th>`).join('');
            document.getElementById('tableBody').innerHTML = rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('');
        }

        window.onload = loadExcelFile;
    </script>
</body>
</html>
