<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STO373 Availability report</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f3f4f6; display: flex; color: #333; }
        .sidebar { width: 260px; background-color: #003399; color: white; padding: 20px; height: 100vh; position: fixed; box-sizing: border-box; overflow-y: auto; z-index: 10; }
        .sidebar h2 { font-size: 20px; margin-bottom: 30px; border-bottom: 2px solid #ffcc00; padding-bottom: 10px; cursor: pointer; transition: opacity 0.2s; }
        .sidebar h2:hover { opacity: 0.8; }
        .sidebar label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; color: #ffd100; }
        .sidebar select, .sidebar input, .sidebar button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: none; background-color: white; color: #333; font-weight: bold; box-sizing: border-box; }
        .sidebar button { background-color: #ffcc00; color: #003399; cursor: pointer; margin-top: 10px; }
        .sidebar button:hover { background-color: #ffd633; }
        
        .time-filter-container { display: flex; gap: 5px; align-items: center; margin-top: 5px; }
        .time-filter-container select { margin-top: 0; }
        
        .upload-section { margin-top: 30px; padding-top: 15px; border-top: 1px dashed #668cff; }
        .upload-section input[type="file"] { background-color: transparent; color: white; padding: 0; font-size: 12px; margin-top: 10px; }
        #fileStatus { font-size: 12px; color: #a3c2ff; margin-top: 5px; line-height: 1.4; }
        
        .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); box-sizing: border-box; }
        .header-title { font-size: 28px; font-weight: bold; margin-bottom: 5px; color: #003399; }
        .header-desc { font-size: 14px; color: #666; margin-bottom: 20px; }
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .table-container { overflow-x: auto; white-space: nowrap; }
        table { border-collapse: collapse; margin-top: 10px; font-size: 13px; text-align: center; width: 100%; }
        th, td { padding: 10px 15px; border: 1px solid #ddd; }
        th { background-color: #f8f9fa; color: #333; font-weight: bold; }
        td:first-child, th:first-child { font-weight: bold; background-color: #eef2f5; text-align: left; position: sticky; left: 0; z-index: 1; } 
        
        th.proj-col { background-color: #ffe8a1; color: #003399; }
        td.proj-cell { background-color: #fff8dc; font-style: italic; }
        
        #loading { font-size: 18px; font-weight: bold; color: #003399; display: flex; align-items: center; margin-bottom: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #ffcc00; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-right: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 onclick="window.location.reload();" title="í™ˆí˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°">ğŸ“Š Availability Report</h2>
        
        <label>1. View Level</label>
        <select id="viewLevel" onchange="updateView()">
            <option value="store">1. Store Overview</option>
            <option value="hfb">2. HFB Level</option>
            <option value="article">3. Article Level</option>
        </select>
        
        <label>â±ï¸ Time Period</label>
        <div class="time-filter-container">
            <select id="fromWeek" onchange="updateView()"><option>Loading...</option></select>
            <span style="color: white; font-weight: bold;">~</span>
            <select id="toWeek" onchange="updateView()"><option>Loading...</option></select>
        </div>

        <div id="storeFilter" style="display: none;">
            <label>2. Select Store</label>
            <select id="storeSelect" onchange="updateView()">
                <option value="Loading...">Loading...</option>
            </select>
        </div>

        <div id="articleFilter" style="display: none;">
            <label>3. Search Article</label>
            <input type="text" id="articleInput" placeholder="ex) 00546468" onkeypress="handleEnter(event)">
            <button onclick="updateView()">ğŸ” Search</button>
        </div>
    </div>

    <div class="main-content">
        <div class="header-title" id="mainTitle">Store Overview</div>
        <div class="header-desc" id="subTitle">í•˜ë‹¨ ë²”ë¡€(Legend)ë¥¼ í´ë¦­í•˜ì—¬ ì›í•˜ëŠ” ì„ ë§Œ ì¼œê³  ëŒ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì ì„  ë° ë…¸ë€ìƒ‰ í‘œì‹œëŠ” ë¬¼ë¥˜ CAPA ê¸°ë°˜ ì˜ˆì¸¡ê°’ì…ë‹ˆë‹¤.)</div>
        
        <div id="loading">
            <div class="spinner"></div>
            <span id="loadingText">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</span>
        </div>
        
        <div id="dashboard" style="display: none;">
            <div class="card">
                <div id="chartDiv" style="width:100%; height:600px;"></div>
            </div>
            
            <div class="card">
                <h3 style="margin-top:0; color:#333; font-size:18px;">Data Table</h3>
                <div class="table-container">
                    <table id="dataTable">
                        <thead><tr id="tableHead"></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let excelData = { AL010: [], Table7: [], SHP: [] }; 
        let projectionData = { store: {}, hfb: {}, article: {}, weeks: [] };
        let lastActualWeek = "";
        let csmToSimulatedWeek = {}; 

        function normArt(val) {
            if (val === undefined || val === null) return "";
            let str = String(val).trim();
            if (/^\d+$/.test(str)) return parseInt(str, 10).toString();
            return str;
        }

        function cleanData(dataArray, columnsToClean) {
            dataArray.forEach(row => {
                columnsToClean.forEach(col => {
                    if (row[col] !== undefined && row[col] !== "") {
                        let strVal = String(row[col]).replace(/[^0-9.-]/g, '');
                        let v = parseFloat(strVal);
                        if (!isNaN(v)) {
                            if (v > 10) { while (v > 1.01) v = v / 100; }
                            if (v > 1) v = 1;
                            if (v < 0) v = 0;
                            row[col] = v;
                        } else {
                            row[col] = 0;
                        }
                    }
                });
            });
            return dataArray;
        }

        function getYearWeek(dateObj, addDays = 0) {
            if(!dateObj || isNaN(dateObj.getTime())) return null;
            let d = new Date(dateObj.getTime());
            d.setDate(d.getDate() + addDays);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            let week1 = new Date(d.getFullYear(), 0, 4);
            let wk = 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            return d.getFullYear() + (wk < 10 ? '0' + wk : String(wk));
        }

        function parseExcelDate(val) {
            if (!val) return null;
            if (val instanceof Date) return val;
            if (typeof val === 'number') return new Date(Math.round((val - 25569) * 86400 * 1000));
            if (typeof val === 'string') {
                let d = new Date(val);
                if (!isNaN(d.getTime())) return d;
            }
            return null;
        }

        async function loadExcelFiles() {
            try {
                const res1 = await fetch('./FY26 OSA.xlsx');
                if (!res1.ok) throw new Error("'FY26 OSA.xlsx' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                const ab1 = await res1.arrayBuffer();
                const wb1 = XLSX.read(ab1, { type: 'array', cellDates: true });

                const res2 = await fetch('./Order.xlsx');
                if (!res2.ok) throw new Error("'Order.xlsx' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                const ab2 = await res2.arrayBuffer();
                const wb2 = XLSX.read(ab2, { type: 'array', cellDates: true });

                const getSheetData = (wb, name, useRaw = true) => {
                    const sheet = wb.Sheets[name];
                    return sheet ? XLSX.utils.sheet_to_json(sheet, { raw: useRaw, defval: "" }).map(row => {
                        let newRow = {};
                        for (let key in row) newRow[key.trim()] = row[key];
                        return newRow;
                    }) : [];
                };

                excelData.STO_OSA = cleanData(getSheetData(wb1, 'STO_OSA'), ['OSA']);
                excelData.HFB = cleanData(getSheetData(wb1, 'HFB'), ['OSA']);
                excelData.Article_level = cleanData(getSheetData(wb1, 'Article_level'), ['OSA', 'ISA']);

                excelData.AL010 = getSheetData(wb2, 'AL010');
                excelData.Table7 = getSheetData(wb2, 'Table_7_Final');

                let shpSheetName = wb2.SheetNames[3]; 
                if(!shpSheetName) throw new Error("Order íŒŒì¼ì— 4ë²ˆì§¸ ì‹œíŠ¸(SHP)ê°€ ì—†ìŠµë‹ˆë‹¤.");
                let rawShpData = XLSX.utils.sheet_to_json(wb2.Sheets[shpSheetName], { header: "A", raw: true, defval: "" });
                
                excelData.SHP = rawShpData.slice(1); 

                if(excelData.AL010.length === 0 || excelData.Table7.length === 0) {
                     throw new Error("'Order.xlsx' íŒŒì¼ ë‚´ì— í•„ìˆ˜ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
                
                setTimeout(() => {
                    runContainerSimulation(); 
                    calculateProjections();   
                    initFilters();
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                }, 100);

            } catch (error) {
                document.getElementById('loading').innerHTML = `<span style="color:red; font-size:16px;">âŒ ì˜¤ë¥˜: ${error.message}</span>`;
                console.error(error);
            }
        }

        function runContainerSimulation() {
            csmToSimulatedWeek = {};
            let containers = {}; 
            
            let simDate = new Date(); 
            simDate.setHours(0,0,0,0);

            let fixedByDate = {}; 

            excelData.SHP.forEach(row => {
                let storeCode = String(row['L'] || '').trim(); 
                if(!storeCode.includes("373")) return;

                let type = String(row['A'] || '').trim().toUpperCase(); 
                let cntrNo = String(row['D'] || '').trim(); 
                let csmId = String(row['F'] || '').trim(); 
                let actualArrDate = parseExcelDate(row['AJ']); 
                let plannedArrDate = parseExcelDate(row['S']); 
                let storeRecvDate = parseExcelDate(row['AT']); 

                if(!cntrNo || !csmId) return;

                if(!containers[cntrNo]) {
                    containers[cntrNo] = {
                        type: type,
                        csmList: [],
                        fixedDate: null,
                        arrivalDate: actualArrDate || plannedArrDate || new Date() 
                    };
                }
                
                if(!containers[cntrNo].csmList.includes(csmId)) {
                    containers[cntrNo].csmList.push(csmId);
                }
                
                if(storeRecvDate) {
                    containers[cntrNo].fixedDate = storeRecvDate;
                }
            });

            let queuedContainers = [];
            
            for(let cntr in containers) {
                let c = containers[cntr];
                if(c.fixedDate && c.fixedDate >= simDate) {
                    let dStr = c.fixedDate.toISOString().split('T')[0];
                    if(!fixedByDate[dStr]) fixedByDate[dStr] = { LF: 0, DD: 0, HF: 0 };
                    
                    if(c.type === 'LF') fixedByDate[dStr].LF++;
                    else if(c.type === 'DD') fixedByDate[dStr].DD++;
                    else if(c.type === 'HF') fixedByDate[dStr].HF++;

                    let fw = getYearWeek(c.fixedDate);
                    c.csmList.forEach(csm => csmToSimulatedWeek[csm] = fw);
                } else {
                    queuedContainers.push(c);
                }
            }

            queuedContainers.sort((a, b) => a.arrivalDate - b.arrivalDate);
            
            let qIndex = 0;
            
            while(qIndex < queuedContainers.length && simDate.getTime() < Date.now() + 90*86400000) {
                
                let dStr = simDate.toISOString().split('T')[0];
                let daily = fixedByDate[dStr] || { LF: 0, DD: 0, HF: 0 };
                
                let totalDaily = daily.LF + daily.HF + daily.DD;
                let quota_LF = Math.max(0, 1 - daily.LF);
                let quota_HF = Math.max(0, 1 - daily.HF);
                let quota_DD = Math.max(0, 3 - daily.DD);

                let scheduledToday = [];

                for(let i = qIndex; i < queuedContainers.length; i++) {
                    let c = queuedContainers[i];
                    if(c.scheduled) continue;
                    if(totalDaily >= 5) break; 

                    if (c.type === 'LF' && quota_LF > 0) {
                        c.scheduled = true; quota_LF--; totalDaily++; scheduledToday.push(c);
                    } else if (c.type === 'HF' && quota_HF > 0) {
                        c.scheduled = true; quota_HF--; totalDaily++; scheduledToday.push(c);
                    } else if (c.type === 'DD' && quota_DD > 0) {
                        c.scheduled = true; quota_DD--; totalDaily++; scheduledToday.push(c);
                    }
                }

                for(let i = qIndex; i < queuedContainers.length; i++) {
                    if(totalDaily >= 5) break;
                    let c = queuedContainers[i];
                    if(c.scheduled) continue;

                    if(c.type === 'HF') {
                        c.scheduled = true; totalDaily++; scheduledToday.push(c);
                    }
                }

                for(let i = qIndex; i < queuedContainers.length; i++) {
                    if(totalDaily >= 5) break;
                    let c = queuedContainers[i];
                    if(c.scheduled) continue;

                    if(c.type === 'DD') {
                        c.scheduled = true; totalDaily++; scheduledToday.push(c);
                    }
                }

                let currentSimWeek = getYearWeek(simDate);
                scheduledToday.forEach(c => {
                    c.csmList.forEach(csm => csmToSimulatedWeek[csm] = currentSimWeek);
                });

                simDate.setDate(simDate.getDate() + 1);
                
                while(qIndex < queuedContainers.length && queuedContainers[qIndex].scheduled) {
                    qIndex++;
                }
            }
        }

        function calculateProjections() {
            projectionData = { store: {}, hfb: {}, article: {}, weeks: [] };

            let allWeeks = excelData.STO_OSA.map(d => String(d['YW - Year Week'])).filter(w => w !== "undefined" && w !== "");
            lastActualWeek = allWeeks.sort()[allWeeks.length - 1]; 
            
            let y = parseInt(lastActualWeek.substring(0,4));
            let w = parseInt(lastActualWeek.substring(4,6));
            
            for(let i=1; i<=6; i++) {
                w++; if(w > 52) { y++; w = 1; }
                projectionData.weeks.push(y + (w < 10 ? '0'+w : ''+w));
            }
            
            let firstProjWeek = projectionData.weeks[0]; 

            let incoming = {};
            excelData.Table7.forEach(row => {
                let itemNo = normArt(row['ItemNo']);
                let csmId = String(row['Csm Id'] || '').trim();
                let qty = parseFloat(row['LatestQty']) || 0;
                
                if(!itemNo || qty <= 0) return;
                
                let targetWk = null;

                if(csmId && csmToSimulatedWeek[csmId]) {
                    targetWk = csmToSimulatedWeek[csmId];
                } 
                else {
                    let mDate = parseExcelDate(row['Planned Receiving Date']);
                    let uDate = parseExcelDate(row['LatestRcvDate']);
                    if(mDate) targetWk = getYearWeek(mDate, 0);       
                    else if(uDate) targetWk = getYearWeek(uDate, 7);  
                    
                    if(targetWk && targetWk <= lastActualWeek) {
                        targetWk = firstProjWeek;
                    }
                }
                
                if(targetWk && projectionData.weeks.includes(targetWk)) {
                    if(!incoming[itemNo]) incoming[itemNo] = {};
                    incoming[itemNo][targetWk] = (incoming[itemNo][targetWk] || 0) + qty;
                }
            });

            excelData.AL010.forEach(row => {
                // ğŸŒŸ í•µì‹¬: SL ê°’ì´ 1~4 ì¸ í™œì„± ì œí’ˆë§Œ ì·¨ê¸‰ (ìœ ë ¹/ë‹¨ì¢… ì œí’ˆ ì™„ë²½ ì»·ì˜¤í”„)
                let slValue = parseInt(row['SL']);
                if (isNaN(slValue) || slValue < 1 || slValue > 4) {
                    return; 
                }

                let storeId = String(row['MHS_ID']); 
                let itemNo = normArt(row['ARTNO']);
                let hfb = String(row['HFB']);
                let avgSales = parseFloat(row['AVGSALES']) || 0;
                let currentStock = parseFloat(row['AVAILABLESTOCK']) || 0;

                if(!projectionData.article[storeId]) projectionData.article[storeId] = {};
                if(!projectionData.hfb[storeId]) projectionData.hfb[storeId] = {};
                if(!projectionData.hfb[storeId][hfb]) projectionData.hfb[storeId][hfb] = {};
                if(!projectionData.store[storeId]) projectionData.store[storeId] = {};

                let projOsaMap = {};
                
                projectionData.weeks.forEach(wk => {
                    let inQty = (incoming[itemNo] && incoming[itemNo][wk]) ? incoming[itemNo][wk] : 0;
                    currentStock += inQty; 
                    
                    let osa = 0;
                    if(avgSales <= 0) {
                        osa = currentStock > 0 ? 1 : 0; 
                    } else {
                        if(currentStock >= avgSales) osa = 1; 
                        else if(currentStock > 0) osa = currentStock / avgSales; 
                        else osa = 0; 
                    }
                    projOsaMap[wk] = Math.min(1, Math.max(0, osa)); 
                    currentStock = Math.max(0, currentStock - avgSales); 
                    
                    if(!projectionData.hfb[storeId][hfb][wk]) projectionData.hfb[storeId][hfb][wk] = { sum:0, cnt:0 };
                    projectionData.hfb[storeId][hfb][wk].sum += projOsaMap[wk];
                    projectionData.hfb[storeId][hfb][wk].cnt++;
                    
                    if(!projectionData.store[storeId][wk]) projectionData.store[storeId][wk] = { sum:0, cnt:0 };
                    projectionData.store[storeId][wk].sum += projOsaMap[wk];
                    projectionData.store[storeId][wk].cnt++;
                });
                
                projectionData.article[storeId][itemNo] = projOsaMap;
            });
        }

        function initFilters() {
            let allWeeks = [...new Set(excelData.STO_OSA.map(d => String(d['YW - Year Week'])))].sort();
            let totalWeeks = allWeeks.concat(projectionData.weeks); 
            
            const fromSelect = document.getElementById('fromWeek');
            const toSelect = document.getElementById('toWeek');
            
            const currFrom = fromSelect.value;
            const currTo = toSelect.value;
            
            const weekOptions = totalWeeks.map(w => `<option value="${w}">${w} ${w > lastActualWeek ? '(Proj)' : ''}</option>`).join('');
            fromSelect.innerHTML = weekOptions;
            toSelect.innerHTML = weekOptions;
            
            if(totalWeeks.length > 0) {
                fromSelect.value = totalWeeks.includes(currFrom) ? currFrom : allWeeks[0]; 
                toSelect.value = totalWeeks.includes(currTo) ? currTo : totalWeeks[totalWeeks.length - 1]; 
            }

            const stores = [...new Set(excelData.STO_OSA.map(d => d['BU - Business Unit']))].sort();
            const storeSelect = document.getElementById('storeSelect');
            storeSelect.innerHTML = stores.map(s => `<option value="${s}" ${s.includes('373') ? 'selected' : ''}>${s}</option>`).join('');
            
            updateView();
        }

        function handleEnter(e) { if (e.key === 'Enter') updateView(); }

        function updateView() {
            const level = document.getElementById('viewLevel').value;
            const store = document.getElementById('storeSelect').value;
            
            document.getElementById('storeFilter').style.display = (level === 'hfb' || level === 'article') ? 'block' : 'none';
            document.getElementById('articleFilter').style.display = (level === 'article') ? 'block' : 'none';

            if (level === 'store') {
                document.getElementById('mainTitle').innerText = `1. Store Overview (Benchmarking)`;
                document.getElementById('subTitle').innerText = `ëª¨ë“  ìŠ¤í† ì–´ì˜ ë°ì´í„°ì…ë‹ˆë‹¤. í•˜ë‹¨ ë²”ë¡€ë¥¼ í´ë¦­í•˜ì—¬ ì›í•˜ëŠ” ìŠ¤í† ì–´ë§Œ ë¹„êµí•´ë³´ì„¸ìš”.`;
                renderStoreData();
            } else if (level === 'hfb') {
                document.getElementById('mainTitle').innerText = `2. HFB Level (${store})`;
                document.getElementById('subTitle').innerText = `í•´ë‹¹ ìŠ¤í† ì–´ì˜ ëª¨ë“  HFB ë°ì´í„°ì…ë‹ˆë‹¤. í•˜ë‹¨ ë²”ë¡€ë¥¼ í´ë¦­í•˜ì—¬ ì›í•˜ëŠ” HFBë§Œ ë¹„êµí•´ë³´ì„¸ìš”.`;
                renderHFBData(store);
            } else if (level === 'article') {
                document.getElementById('mainTitle').innerText = `3. Article Level (${store})`;
                document.getElementById('subTitle').innerText = `ì¢Œì¸¡ì—ì„œ ì œí’ˆ ë²ˆí˜¸ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”. (ì˜ˆ: 00546468)`;
                renderArticleData(store);
            }
        }

        function getCombinedData(actualDataRows, storeCode, extractProjFunc) {
            const fromWk = document.getElementById('fromWeek').value;
            const toWk = document.getElementById('toWeek').value;
            
            let actuals = actualDataRows.filter(d => d['OSA'] !== "" && !isNaN(parseFloat(d['OSA'])))
                                        .sort((a,b) => a['YW - Year Week'] - b['YW - Year Week']);
            
            let weeks = [], osas = [], isProjMap = {};

            actuals.forEach(d => {
                let wk = String(d['YW - Year Week']);
                if(wk >= fromWk && wk <= toWk) {
                    weeks.push(wk); osas.push(parseFloat(d['OSA'])); isProjMap[wk] = false;
                }
            });

            if(projectionData.weeks.length > 0) {
                let projObj = extractProjFunc();
                if(projObj) {
                    projectionData.weeks.forEach(wk => {
                        if(wk >= fromWk && wk <= toWk && projObj[wk] !== undefined) {
                            weeks.push(wk); osas.push(projObj[wk]); isProjMap[wk] = true;
                        }
                    });
                }
            }
            return { weeks, osas, isProjMap };
        }

        function renderStoreData() {
            let stores = [...new Set(excelData.STO_OSA.map(d => d['BU - Business Unit']))].sort();
            let traces = [], tableRows = [], tableWeeks = [], isProjFlags = {};
            let allY = []; 

            stores.forEach(st => {
                let storeCode = st.split(' - ')[0]; 
                let stActuals = excelData.STO_OSA.filter(d => d['BU - Business Unit'] === st);
                
                let { weeks, osas, isProjMap } = getCombinedData(stActuals, storeCode, () => {
                    if(projectionData.store[storeCode]) {
                        let res = {};
                        for(let w in projectionData.store[storeCode]) {
                            let cnt = projectionData.store[storeCode][w].cnt;
                            res[w] = cnt > 0 ? projectionData.store[storeCode][w].sum / cnt : 0;
                        }
                        return res;
                    }
                    return null;
                });

                if (weeks.length > 0) {
                    if(tableWeeks.length === 0) { tableWeeks = weeks; isProjFlags = isProjMap; } 
                    
                    let actX=[], actY=[], projX=[], projY=[], lastActX=null, lastActY=null;
                    weeks.forEach((w, i) => {
                        allY.push(osas[i]); 
                        if(isProjMap[w]) {
                            if(projX.length===0 && lastActX) { projX.push(lastActX); projY.push(lastActY); }
                            projX.push(w); projY.push(osas[i]);
                        } else {
                            actX.push(w); actY.push(osas[i]); lastActX = w; lastActY = osas[i];
                        }
                    });

                    traces.push({ x: actX, y: actY, type: 'scatter', mode: 'lines+markers', name: st, legendgroup: st });
                    if(projX.length > 0) traces.push({ x: projX, y: projY, type: 'scatter', mode: 'lines+markers', line: { dash: 'dot', width: 2 }, name: st + ' (Proj)', showlegend: false, legendgroup: st });

                    tableRows.push([st].concat(osas.map(v => (v * 100).toFixed(1) + '%')));
                }
            });

            let validY = allY.filter(v => !isNaN(v) && v !== null);
            let minY = validY.length > 0 ? Math.min(...validY) : 0;
            let calculatedMin = Math.max(0, minY - 0.05); 

            Plotly.newPlot('chartDiv', traces, { 
                title: 'All Stores - Weekly OSA Trend', 
                xaxis: { type: 'category' }, 
                yaxis: { tickformat: '.1%', range: [calculatedMin, 1.05] }, 
                margin: { t: 40, b: 120 }, 
                legend: { orientation: 'h', yanchor: 'top', y: -0.15 } 
            });
            drawTable(['Store'].concat(tableWeeks), tableRows, tableWeeks.map(w => isProjFlags[w]));
        }

        function renderHFBData(store) {
            let storeCode = store.split(' - ')[0];
            let actData = excelData.HFB.filter(d => d['BU - Business Unit'] === store);
            let hfbs = [...new Set(actData.map(d => d['HFB Name - Home Furnishing Business Name']))].sort();
            
            let traces = [], tableRows = [], tableWeeks = [], isProjFlags = {};
            let allY = []; 

            hfbs.forEach(hfb => {
                let hfbNumStr = parseInt(hfb.split(' - ')[0]).toString(); 
                let hfbActuals = actData.filter(d => d['HFB Name - Home Furnishing Business Name'] === hfb);
                
                let { weeks, osas, isProjMap } = getCombinedData(hfbActuals, storeCode, () => {
                    if(projectionData.hfb[storeCode] && projectionData.hfb[storeCode][hfbNumStr]) {
                        let res = {};
                        for(let w in projectionData.hfb[storeCode][hfbNumStr]) {
                            let cnt = projectionData.hfb[storeCode][hfbNumStr][w].cnt;
                            res[w] = cnt > 0 ? projectionData.hfb[storeCode][hfbNumStr][w].sum / cnt : 0;
                        }
                        return res;
                    }
                    return null;
                });

                if (weeks.length > 0) {
                    if(tableWeeks.length === 0) { tableWeeks = weeks; isProjFlags = isProjMap; }
                    
                    let actX=[], actY=[], projX=[], projY=[], lastX=null, lastY=null;
                    weeks.forEach((w, i) => {
                        allY.push(osas[i]); 
                        if(isProjMap[w]) {
                            if(projX.length===0 && lastX) { projX.push(lastX); projY.push(lastY); }
                            projX.push(w); projY.push(osas[i]);
                        } else {
                            actX.push(w); actY.push(osas[i]); lastX = w; lastY = osas[i];
                        }
                    });

                    traces.push({ x: actX, y: actY, type: 'scatter', mode: 'lines+markers', name: hfb, legendgroup: hfb });
                    if(projX.length > 0) traces.push({ x: projX, y: projY, type: 'scatter', mode: 'lines+markers', line: { dash: 'dot' }, name: hfb, showlegend: false, legendgroup: hfb });

                    tableRows.push([hfb].concat(osas.map(v => (v * 100).toFixed(1) + '%')));
                }
            });

            let validY = allY.filter(v => !isNaN(v) && v !== null);
            let minY = validY.length > 0 ? Math.min(...validY) : 0;
            let calculatedMin = Math.max(0, minY - 0.05);

            Plotly.newPlot('chartDiv', traces, { 
                title: `All HFBs in ${store}`, 
                xaxis: { type: 'category' }, 
                yaxis: { tickformat: '.1%', range: [calculatedMin, 1.05] },
                margin: { t: 40, b: 120 }, 
                legend: { orientation: 'h', yanchor: 'top', y: -0.15 } 
            });
            drawTable(['HFB Name'].concat(tableWeeks), tableRows, tableWeeks.map(w => isProjFlags[w]));
        }

        function renderArticleData(store) {
            const rawItemNo = document.getElementById('articleInput').value.trim();
            const itemNo = normArt(rawItemNo);
            
            if(!itemNo) { Plotly.newPlot('chartDiv', []); drawTable([], []); return; }
            
            let storeCode = store.split(' - ')[0];
            let actuals = excelData.Article_level.filter(d => d['BU - Business Unit'] === store && normArt(d['Item Number']) === itemNo);
            
            let { weeks, osas, isProjMap } = getCombinedData(actuals, storeCode, () => {
                if(projectionData.article[storeCode] && projectionData.article[storeCode][itemNo]) return projectionData.article[storeCode][itemNo];
                return null;
            });

            if (weeks.length === 0) { alert(`í•´ë‹¹ ê¸°ê°„ì— "${rawItemNo}" ì œí’ˆì˜ ë°ì´í„°/ì˜ˆì¸¡ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`); return; }

            let actX=[], actY=[], projX=[], projY=[], lastX=null, lastY=null;
            let allY = []; 

            weeks.forEach((w, i) => {
                allY.push(osas[i]);
                if(isProjMap[w]) {
                    if(projX.length===0 && lastX) { projX.push(lastX); projY.push(lastY); }
                    projX.push(w); projY.push(osas[i]);
                } else {
                    actX.push(w); actY.push(osas[i]); lastX = w; lastY = osas[i];
                }
            });

            let traces = [{ x: actX, y: actY, type: 'scatter', mode: 'lines+markers', name: 'OSA', line: {color: '#0058a3'} }];
            if(projX.length > 0) traces.push({ x: projX, y: projY, type: 'scatter', mode: 'lines+markers', name: 'OSA (Proj)', line: {color: '#0058a3', dash: 'dot'} });

            let isaX = [], isaY = [];
            actuals.forEach(d => {
                let wk = String(d['YW - Year Week']);
                if(!isProjMap[wk] && weeks.includes(wk)) { 
                    let isaVal = parseFloat(d['ISA']);
                    isaX.push(wk); isaY.push(isaVal); 
                    allY.push(isaVal); 
                }
            });
            traces.push({ x: isaX, y: isaY, type: 'scatter', mode: 'lines+markers', name: 'ISA', line: {color: '#ff9900'} });

            let validY = allY.filter(v => !isNaN(v) && v !== null);
            let minY = validY.length > 0 ? Math.min(...validY) : 0;
            let calculatedMin = Math.max(0, minY - 0.05);

            Plotly.newPlot('chartDiv', traces, { 
                title: `Item: ${itemNo} - OSA vs Projection`, 
                xaxis: { type: 'category' }, 
                yaxis: { tickformat: '.0%', range: [calculatedMin, 1.05] },
                margin: { t: 40, b: 120 }, 
                legend: { orientation: 'h', yanchor: 'top', y: -0.15 } 
            });
            
            let isaRowData = ['ISA %'];
            weeks.forEach(w => {
                let match = actuals.find(d => normArt(d['Item Number']) === itemNo && String(d['YW - Year Week']) === w);
                isaRowData.push(match ? (parseFloat(match['ISA']) * 100).toFixed(1) + '%' : '-');
            });
            drawTable(['Metric'].concat(weeks), [['OSA %'].concat(osas.map(v => (v * 100).toFixed(1) + '%')), isaRowData], weeks.map(w => isProjMap[w]));
        }

        function drawTable(headers, rows, isProjArray = []) {
            if(headers.length === 0) { document.getElementById('tableHead').innerHTML = ""; document.getElementById('tableBody').innerHTML = ""; return; }
            
            document.getElementById('tableHead').innerHTML = headers.map((h, i) => {
                let isProj = (i > 0 && isProjArray[i-1]) ? true : false; 
                return `<th class="${isProj ? 'proj-col' : ''}">${h} ${isProj ? '<br>(Proj)' : ''}</th>`;
            }).join('');
            
            document.getElementById('tableBody').innerHTML = rows.map(r => `<tr>${r.map((c, i) => {
                let isProj = (i > 0 && isProjArray[i-1]) ? true : false;
                return `<td class="${isProj ? 'proj-cell' : ''}">${c}</td>`;
            }).join('')}</tr>`).join('');
        }

        window.onload = loadExcelFiles;
    </script>
</body>
</html>
